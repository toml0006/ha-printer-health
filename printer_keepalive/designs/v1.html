<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>__APP_NAME__ — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg: #f5f5f7;
  --card: #ffffff;
  --text: #1d1d1f;
  --text-secondary: #86868b;
  --text-tertiary: #aeaeb2;
  --accent: #0071e3;
  --accent-light: rgba(0,113,227,0.08);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 6px 16px rgba(0,0,0,0.04);
  --shadow-hover: 0 2px 8px rgba(0,0,0,0.08), 0 12px 28px rgba(0,0,0,0.06);
  --divider: rgba(0,0,0,0.06);
  --radius: 20px;
  --radius-sm: 12px;
  --gap: 16px;
  --pad: 24px;
  --transition: 0.2s ease;
}

[data-theme="dark"] {
  --bg: #1d1d1f;
  --card: #2d2d2f;
  --text: #f5f5f7;
  --text-secondary: #98989d;
  --text-tertiary: #6e6e73;
  --accent: #2997ff;
  --accent-light: rgba(41,151,255,0.12);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2), 0 6px 16px rgba(0,0,0,0.15);
  --shadow-hover: 0 2px 8px rgba(0,0,0,0.25), 0 12px 28px rgba(0,0,0,0.2);
  --divider: rgba(255,255,255,0.08);
}

body {
  font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background var(--transition), color var(--transition);
  -webkit-font-smoothing: antialiased;
}

/* CMYK stripe */
.cmyk-stripe {
  height: 3px;
  background: linear-gradient(90deg, #00bcd4 25%, #e91e63 25%, #e91e63 50%, #ffc107 50%, #ffc107 75%, #263238 75%);
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

/* Layout */
.container {
  max-width: 1120px;
  margin: 0 auto;
  padding: 3px 24px 80px;
}

/* Top Bar */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 28px 0 20px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-icon {
  width: 36px;
  height: 36px;
  background: var(--accent);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.brand-icon svg {
  width: 20px;
  height: 20px;
  fill: #fff;
}

.brand-title {
  font-weight: 600;
  font-size: 20px;
  letter-spacing: -0.3px;
}

.brand-version {
  font-size: 11px;
  font-weight: 500;
  color: var(--accent);
  background: var(--accent-light);
  padding: 3px 8px;
  border-radius: 6px;
  letter-spacing: 0.2px;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.design-switcher {
  padding: 6px 10px;
  border: 1px solid var(--divider);
  border-radius: 10px;
  background: var(--card);
  color: var(--text);
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
}

.design-switcher:focus {
  outline: none;
  border-color: var(--accent);
}

.auth-toggle-btn {
  background: var(--card);
  border: 1px solid var(--divider);
  border-radius: 10px;
  padding: 7px 10px;
  cursor: pointer;
  color: var(--text-tertiary);
  font-size: 14px;
  line-height: 1;
  box-shadow: var(--shadow-sm);
  transition: all var(--transition);
  position: relative;
}

.auth-toggle-btn.has-token { color: var(--accent); border-color: var(--accent); }

.auth-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 6px);
  right: 0;
  background: var(--card);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-hover);
  padding: 16px;
  z-index: 500;
  width: 280px;
  border: 1px solid var(--divider);
}

.auth-dropdown.open { display: block; }

.auth-dropdown label {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  display: block;
  margin-bottom: 6px;
}

.auth-dropdown input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--divider);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 12px;
  margin-bottom: 10px;
}

.auth-dropdown input:focus {
  outline: none;
  border-color: var(--accent);
}

.auth-dropdown .btn-row { justify-content: flex-end; }

.auth-wrapper { position: relative; }

.theme-toggle {
  display: flex;
  background: var(--card);
  border-radius: 10px;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.theme-btn {
  background: none;
  border: none;
  padding: 8px 12px;
  cursor: pointer;
  color: var(--text-tertiary);
  font-size: 16px;
  transition: all var(--transition);
  line-height: 1;
}

.theme-btn.active {
  color: var(--accent);
  background: var(--accent-light);
}

/* Tabs */
.tabs {
  display: flex;
  gap: 32px;
  padding-bottom: 2px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--divider);
}

.tab-btn {
  background: none;
  border: none;
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  padding: 10px 0;
  cursor: pointer;
  position: relative;
  transition: color var(--transition);
}

.tab-btn::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--accent);
  border-radius: 1px;
  transform: scaleX(0);
  transition: transform 0.25s ease;
}

.tab-btn:hover { color: var(--text); }
.tab-btn.active { color: var(--text); }
.tab-btn.active::after { transform: scaleX(1); }

/* Views */
.view { display: none; }
.view.active { display: block; }

/* Bento Grid */
.bento {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--gap);
}

/* Cards */
.card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  padding: var(--pad);
  transition: background var(--transition), box-shadow var(--transition), transform 0.3s ease;
  opacity: 0;
  transform: translateY(16px);
}

.card:hover {
  box-shadow: var(--shadow-hover);
}

.card.visible {
  opacity: 1;
  transform: translateY(0);
}

/* Span helpers */
.span-2 { grid-column: span 2; }
.span-3 { grid-column: span 3; }
.row-2 { grid-row: span 2; }

/* Metric Card */
.metric-label {
  font-size: 11px;
  font-weight: 500;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 6px;
}

.metric-value {
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -1px;
  line-height: 1.1;
  margin-bottom: 6px;
}

.metric-sub {
  font-size: 12px;
  color: var(--text-secondary);
  font-weight: 400;
}

.metric-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: var(--accent-light);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 14px;
}

.metric-icon svg {
  width: 16px;
  height: 16px;
  fill: var(--accent);
}

/* Card Title */
.card-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.6px;
  margin-bottom: 20px;
}

/* Printer Row */
.printer-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid var(--divider);
}

.printer-row:last-child { border-bottom: none; }

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-dot.ok { background: #30d158; box-shadow: 0 0 8px rgba(48,209,88,0.4); }
.status-dot.warning { background: #ffd60a; box-shadow: 0 0 8px rgba(255,214,10,0.4); }
.status-dot.error { background: #ff453a; box-shadow: 0 0 8px rgba(255,69,58,0.4); }

.printer-info { flex: 1; min-width: 0; }

.printer-name {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 2px;
}

.printer-state {
  font-size: 12px;
  color: var(--text-secondary);
}

.printer-due {
  font-size: 12px;
  color: var(--text-secondary);
  text-align: right;
  white-space: nowrap;
}

.printer-due .due-label {
  font-size: 10px;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Key-Value list */
.kv-list { list-style: none; }

.kv-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--divider);
  font-size: 13px;
}

.kv-item:last-child { border-bottom: none; }

.kv-key {
  color: var(--text-secondary);
  font-weight: 400;
}

.kv-val {
  font-weight: 500;
  text-align: right;
  max-width: 55%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.kv-val.ok { color: #30d158; }
.kv-val.warn { color: #ffd60a; }

/* Buttons */
.btn {
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  border: none;
  border-radius: 10px;
  padding: 10px 18px;
  cursor: pointer;
  transition: all var(--transition);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--accent);
  color: #fff;
}

.btn-primary:hover:not(:disabled) { filter: brightness(1.1); }

.btn-secondary {
  background: var(--accent-light);
  color: var(--accent);
}

.btn-secondary:hover:not(:disabled) { background: var(--accent); color: #fff; }

.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--divider);
}

.btn-ghost:hover:not(:disabled) { background: var(--accent-light); color: var(--accent); border-color: transparent; }

.btn-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* Quick action buttons */
.quick-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 4px;
}

.quick-actions .btn {
  width: 100%;
  text-align: center;
}

/* Printer Detail Cards (Printers view) */
.printer-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: var(--gap);
}

.printer-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
}

.printer-card-header .printer-name { font-size: 16px; }

.printer-card-uri {
  font-size: 11px;
  color: var(--text-tertiary);
  font-family: 'SF Mono', 'Fira Code', monospace;
  margin-top: 2px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 18px;
}

.stat-box {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 12px;
}

.stat-box .stat-label {
  font-size: 10px;
  font-weight: 500;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.stat-box .stat-value {
  font-size: 14px;
  font-weight: 600;
}

.control-row {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 18px;
  flex-wrap: wrap;
}

.control-row label {
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.control-row input[type="checkbox"] {
  accent-color: var(--accent);
  width: 16px;
  height: 16px;
}

.control-row input[type="number"] {
  width: 64px;
  padding: 6px 8px;
  border: 1px solid var(--divider);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
}

.control-row select {
  padding: 6px 10px;
  border: 1px solid var(--divider);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
}

/* Discovery table */
.disc-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.disc-table th {
  text-align: left;
  font-weight: 500;
  color: var(--text-tertiary);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 8px 12px;
  border-bottom: 1px solid var(--divider);
}

.disc-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--divider);
  vertical-align: middle;
}

.disc-table tr:last-child td { border-bottom: none; }

.disc-table .mono {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 12px;
  color: var(--text-secondary);
}

.pill {
  display: inline-block;
  font-size: 11px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 6px;
}

.pill-green { background: rgba(48,209,88,0.12); color: #30d158; }
.pill-red { background: rgba(255,69,58,0.12); color: #ff453a; }
.pill-blue { background: var(--accent-light); color: var(--accent); }
.pill-gray { background: var(--divider); color: var(--text-secondary); }

/* Config view */
.config-editor {
  width: 100%;
  min-height: 280px;
  background: var(--bg);
  border: 1px solid var(--divider);
  border-radius: var(--radius-sm);
  padding: 16px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 13px;
  color: var(--text);
  resize: vertical;
  line-height: 1.6;
}

.config-editor:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

/* Config mode toggle (pill segmented control) */
.config-mode-toggle {
  display: inline-flex;
  background: var(--bg);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 20px;
  border: 1px solid var(--divider);
}

.config-mode-btn {
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  border: none;
  background: none;
  padding: 7px 18px;
  border-radius: 8px;
  cursor: pointer;
  color: var(--text-secondary);
  transition: all var(--transition);
}

.config-mode-btn.active {
  background: var(--card);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

/* Config form styles */
.cfg-section {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  margin-bottom: 16px;
  overflow: hidden;
}

.cfg-section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px var(--pad);
  cursor: pointer;
  user-select: none;
  transition: background var(--transition);
}

.cfg-section-header:hover {
  background: var(--accent-light);
}

.cfg-section-title {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: -0.2px;
}

.cfg-section-chevron {
  font-size: 12px;
  color: var(--text-tertiary);
  transition: transform 0.25s ease;
}

.cfg-section.collapsed .cfg-section-chevron {
  transform: rotate(-90deg);
}

.cfg-section-body {
  padding: 0 var(--pad) var(--pad);
}

.cfg-section.collapsed .cfg-section-body {
  display: none;
}

/* Form field */
.cfg-field {
  margin-bottom: 18px;
}

.cfg-field:last-child {
  margin-bottom: 0;
}

.cfg-field-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 5px;
}

.cfg-field-desc {
  font-size: 11px;
  color: var(--text-tertiary);
  margin-top: 4px;
}

.cfg-field input[type="text"],
.cfg-field input[type="password"],
.cfg-field input[type="number"],
.cfg-field textarea,
.cfg-field select {
  width: 100%;
  padding: 9px 12px;
  border: 1px solid var(--divider);
  border-radius: 10px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 400;
  transition: border-color var(--transition), box-shadow var(--transition);
}

.cfg-field input[type="text"]:focus,
.cfg-field input[type="password"]:focus,
.cfg-field input[type="number"]:focus,
.cfg-field textarea:focus,
.cfg-field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.cfg-field textarea {
  min-height: 80px;
  resize: vertical;
  line-height: 1.5;
}

.cfg-field-suffix {
  display: inline-block;
  font-size: 12px;
  color: var(--text-tertiary);
  margin-left: 6px;
}

.cfg-field-inline {
  display: flex;
  align-items: center;
  gap: 8px;
}

.cfg-field-inline input[type="number"] {
  width: 100px;
}

/* Custom toggle switch */
.cfg-toggle-wrap {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cfg-toggle {
  position: relative;
  width: 42px;
  height: 24px;
  flex-shrink: 0;
}

.cfg-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
  position: absolute;
}

.cfg-toggle-track {
  position: absolute;
  inset: 0;
  background: var(--divider);
  border-radius: 12px;
  transition: background 0.25s ease;
  cursor: pointer;
}

.cfg-toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  transition: transform 0.25s ease;
}

.cfg-toggle input:checked + .cfg-toggle-track {
  background: var(--accent);
}

.cfg-toggle input:checked + .cfg-toggle-track::after {
  transform: translateX(18px);
}

/* Printer config card */
.cfg-printer-card {
  background: var(--bg);
  border-radius: var(--radius-sm);
  margin-bottom: 12px;
  overflow: hidden;
  border: 1px solid var(--divider);
}

.cfg-printer-card:last-of-type {
  margin-bottom: 12px;
}

.cfg-printer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  font-weight: 500;
}

.cfg-printer-header:hover {
  background: var(--accent-light);
}

.cfg-printer-body {
  padding: 0 16px 16px;
}

.cfg-printer-card.collapsed .cfg-printer-body {
  display: none;
}

.cfg-printer-remove {
  font-size: 12px;
  color: #ff453a;
  background: rgba(255,69,58,0.1);
  border: none;
  border-radius: 6px;
  padding: 4px 10px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
  transition: all var(--transition);
}

.cfg-printer-remove:hover {
  background: #ff453a;
  color: #fff;
}

/* View subtitle */
.view-header {
  margin-bottom: 24px;
}

.view-title {
  font-size: 24px;
  font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 4px;
}

.view-sub {
  font-size: 14px;
  color: var(--text-secondary);
}

/* Toast notification */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--card);
  color: var(--text);
  padding: 12px 24px;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-hover);
  font-size: 13px;
  font-weight: 500;
  z-index: 2000;
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
  pointer-events: none;
  border: 1px solid var(--divider);
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast.toast-error {
  border-color: #ff453a;
  color: #ff453a;
}

/* Cards view - YAML code blocks */
.yaml-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(440px, 1fr));
  gap: var(--gap);
}

.yaml-block {
  background: #1e1e2e;
  color: #cdd6f4;
  border-radius: var(--radius-sm);
  padding: 16px;
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 12px;
  line-height: 1.6;
  overflow-x: auto;
  white-space: pre;
  margin: 12px 0;
  max-height: 400px;
  overflow-y: auto;
}

[data-theme="dark"] .yaml-block {
  background: #111118;
}

.yaml-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.yaml-card-header .printer-name {
  font-size: 16px;
  font-weight: 600;
}

.yaml-style-select {
  padding: 6px 12px;
  border: 1px solid var(--divider);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
}

.yaml-style-select:focus {
  outline: none;
  border-color: var(--accent);
}

.btn-copy-yaml {
  margin-top: 8px;
}

/* Templates view - preview images */
.tpl-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
  gap: var(--gap);
}

.tpl-preview-img {
  width: 100%;
  max-width: 400px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--divider);
  margin: 12px 0;
  display: block;
  background: var(--bg);
}

.tpl-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
  margin: 8px 0 12px;
}

.tpl-select {
  padding: 6px 12px;
  border: 1px solid var(--divider);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
}

.tpl-select:focus {
  outline: none;
  border-color: var(--accent);
}

/* Help view */
.help-content {
  max-width: 800px;
}

.help-content .card {
  opacity: 1;
  transform: none;
  margin-bottom: var(--gap);
}

.help-section-title {
  font-size: 18px;
  font-weight: 700;
  letter-spacing: -0.3px;
  margin-bottom: 12px;
  color: var(--text);
}

.help-body {
  font-size: 14px;
  line-height: 1.7;
  color: var(--text-secondary);
}

.help-body ul {
  list-style: none;
  padding: 0;
  margin: 8px 0;
}

.help-body ul li {
  padding: 4px 0 4px 16px;
  position: relative;
}

.help-body ul li::before {
  content: '';
  position: absolute;
  left: 0;
  top: 12px;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--accent);
}

.help-body h4 {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  margin: 14px 0 6px;
}

.help-body code {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 12px;
  background: var(--accent-light);
  color: var(--accent);
  padding: 2px 6px;
  border-radius: 4px;
}

.help-body a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 500;
}

.help-body a:hover {
  text-decoration: underline;
}

.help-collapsible {
  border: 1px solid var(--divider);
  border-radius: var(--radius-sm);
  overflow: hidden;
  margin: 12px 0;
}

.help-collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
  background: var(--bg);
  transition: background var(--transition);
}

.help-collapsible-header:hover {
  background: var(--accent-light);
}

.help-collapsible-chevron {
  font-size: 11px;
  color: var(--text-tertiary);
  transition: transform 0.25s ease;
}

.help-collapsible.collapsed .help-collapsible-chevron {
  transform: rotate(-90deg);
}

.help-collapsible-body {
  padding: 12px 16px;
}

.help-collapsible.collapsed .help-collapsible-body {
  display: none;
}

.help-entity-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin: 8px 0;
}

.help-entity-group h4 {
  margin-top: 0;
}

.help-endpoint {
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 12px;
  padding: 4px 0;
  color: var(--text-secondary);
}

.help-endpoint .method {
  display: inline-block;
  width: 44px;
  font-weight: 600;
  color: var(--accent);
}

/* Config section description + learn more link */
.cfg-section-desc {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-top: 2px;
}

.cfg-section-desc a {
  color: var(--accent);
  text-decoration: none;
  font-weight: 500;
  margin-left: 6px;
}

.cfg-section-desc a:hover {
  text-decoration: underline;
}

/* Responsive */
@media (max-width: 900px) {
  .bento {
    grid-template-columns: repeat(2, 1fr);
  }
  .span-3 { grid-column: span 2; }
}

@media (max-width: 600px) {
  .container { padding: 3px 16px 80px; }
  .bento {
    grid-template-columns: 1fr;
  }
  .span-2, .span-3 { grid-column: span 1; }
  .row-2 { grid-row: span 1; }
  .tabs { gap: 12px; overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
  .tab-btn { white-space: nowrap; font-size: 13px; }
  .topbar { flex-wrap: wrap; gap: 12px; }
  .metric-value { font-size: 26px; }
  .printer-cards { grid-template-columns: 1fr; }
  .yaml-cards { grid-template-columns: 1fr; }
  .tpl-cards { grid-template-columns: 1fr; }
  .help-entity-grid { grid-template-columns: 1fr; }
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="cmyk-stripe"></div>

<div class="container">
  <!-- Top Bar -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
      </div>
      <span class="brand-title">__APP_NAME__</span>
      <span class="brand-version" id="version-badge"></span>
    </div>
    <div class="topbar-right">
      <select class="design-switcher" id="design-switcher">
        <option value="v1" selected>Bento Grid</option>
        <option value="v2">Glassmorphism</option>
        <option value="v3">Neubrutalist</option>
        <option value="v4">Cinematic Dark</option>
        <option value="v5">Home Assistant</option>
      </select>
      <div class="auth-wrapper">
        <button class="auth-toggle-btn" id="auth-toggle" title="Auth Token">&#9919;</button>
        <div class="auth-dropdown" id="auth-dropdown">
          <label for="auth-token-input">Bearer Token</label>
          <input type="password" id="auth-token-input" placeholder="Paste token here...">
          <div class="btn-row">
            <button class="btn btn-ghost" id="auth-clear">Clear</button>
            <button class="btn btn-primary" id="auth-save">Save</button>
          </div>
        </div>
      </div>
      <div class="theme-toggle">
        <button class="theme-btn" id="theme-light" title="Light mode">&#9788;</button>
        <button class="theme-btn" id="theme-dark" title="Dark mode">&#9790;</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="tabs" id="tabs"></nav>

  <!-- Dashboard View -->
  <section class="view active" id="view-dashboard">
    <div class="bento" id="bento-dashboard"></div>
  </section>

  <!-- Printers View -->
  <section class="view" id="view-printers">
    <div class="view-header" style="display:flex;align-items:flex-start;justify-content:space-between">
      <div>
        <h2 class="view-title">Printers</h2>
        <p class="view-sub">Manage keepalive settings for each configured printer.</p>
      </div>
      <button class="btn btn-primary" id="printers-add-btn-header" style="flex-shrink:0">+ Add Printer</button>
    </div>
    <div class="printer-cards" id="printer-cards"></div>
  </section>

  <!-- Discovery View -->
  <section class="view" id="view-discovery">
    <div class="view-header">
      <h2 class="view-title">Discovery</h2>
      <p class="view-sub">Network printers found via IPP/DNS-SD scanning.</p>
    </div>
    <div id="discovery-content"></div>
  </section>

  <!-- Cards View -->
  <section class="view" id="view-cards">
    <div class="view-header">
      <h2 class="view-title">Lovelace Cards</h2>
      <p class="view-sub">Copy generated YAML to add printer cards to your Home Assistant dashboard.</p>
    </div>
    <div class="yaml-cards" id="cards-content"></div>
  </section>

  <!-- Templates View -->
  <section class="view" id="view-templates">
    <div class="view-header">
      <h2 class="view-title">Print Templates</h2>
      <p class="view-sub">Preview and print maintenance page templates for each printer.</p>
    </div>
    <div class="tpl-cards" id="templates-content"></div>
  </section>

  <!-- Config View -->
  <section class="view" id="view-config">
    <div class="view-header">
      <h2 class="view-title">Configuration</h2>
      <p class="view-sub">Manage add-on settings using the form or edit raw JSON.</p>
    </div>
    <div class="config-mode-toggle">
      <button class="config-mode-btn active" data-mode="form">Form</button>
      <button class="config-mode-btn" data-mode="advanced">Advanced (JSON)</button>
    </div>
    <div id="config-form-view"></div>
    <div id="config-raw-view" style="display:none"></div>
    <div class="card" style="opacity:1;transform:none;margin-top:16px">
      <div class="btn-row">
        <button class="btn btn-primary" id="cfg-save">Save Config</button>
        <button class="btn btn-secondary" id="cfg-load">Load Config</button>
        <button class="btn btn-ghost" id="cfg-restart">Restart App</button>
      </div>
    </div>
  </section>

  <!-- Help View -->
  <section class="view" id="view-help">
    <div class="view-header">
      <h2 class="view-title">Help &amp; Documentation</h2>
      <p class="view-sub">Everything you need to know about Printer Keepalive.</p>
    </div>
    <div class="help-content" id="help-content"></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script>
/* ── API helpers ─────────────────────────────────────────── */
function apiPath(path) {
  var pathname = window.location.pathname;
  var base = pathname.replace(/\/design\/v[1-5]\/?$/, '/');
  if (!base.endsWith('/')) base += '/';
  var origin = window.location.origin;
  var clean = String(path || '').replace(/^\/+/, '');
  return new URL(clean, origin + base).toString();
}

var state = {
  authToken: localStorage.getItem('pk_auth_token') || '',
  refreshInFlight: false,
  health: null,
  discovery: null,
  configLoaded: false
};

async function requestJson(path, init) {
  if (!init) init = {};
  var headers = Object.assign({}, init.headers || {});
  if (init.body !== undefined && !headers['Content-Type']) headers['Content-Type'] = 'application/json';
  if (state.authToken) headers['Authorization'] = 'Bearer ' + state.authToken;
  var response = await fetch(apiPath(path), Object.assign({}, init, { headers: headers }));
  var raw = await response.text();
  var payload = {};
  if (raw) {
    try { payload = JSON.parse(raw); }
    catch (err) { throw new Error('Invalid JSON: ' + path + ' (' + response.status + ')'); }
  }
  if (!response.ok || (payload && payload.ok === false)) {
    var message = (payload && (payload.error || payload.details || payload.reason)) || (response.status + ' ' + response.statusText);
    throw new Error(message);
  }
  return payload;
}

/* ── Toast ───────────────────────────────────────────────── */
var toastTimer = null;
function showToast(msg, isError) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isError ? ' toast-error' : '');
  void t.offsetWidth;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() { t.classList.remove('show'); }, 3000);
}

/* ── Helpers ─────────────────────────────────────────────── */
function relTime(iso) {
  if (!iso) return '\u2014';
  var diff = Date.now() - new Date(iso).getTime();
  var abs = Math.abs(diff);
  var future = diff < 0;
  var m = Math.floor(abs / 60000);
  var h = Math.floor(abs / 3600000);
  var d = Math.floor(abs / 86400000);
  var str;
  if (d > 0) str = d + 'd';
  else if (h > 0) str = h + 'h';
  else str = m + 'm';
  return future ? 'in ' + str : str + ' ago';
}

function shortDate(iso) {
  if (!iso) return '\u2014';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function el(tag, cls, html) {
  var e = document.createElement(tag);
  if (cls) e.className = cls;
  if (html !== undefined) e.innerHTML = html;
  return e;
}

function escHtml(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

/* ── Theme ───────────────────────────────────────────────── */
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('pk-theme', t);
  document.getElementById('theme-light').classList.toggle('active', t === 'light');
  document.getElementById('theme-dark').classList.toggle('active', t === 'dark');
}

document.getElementById('theme-light').onclick = function() { setTheme('light'); };
document.getElementById('theme-dark').onclick = function() { setTheme('dark'); };
setTheme(localStorage.getItem('pk-theme') || (matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light'));

/* ── Auth dropdown ───────────────────────────────────────── */
(function() {
  var toggle = document.getElementById('auth-toggle');
  var dropdown = document.getElementById('auth-dropdown');
  var input = document.getElementById('auth-token-input');
  var saveBtn = document.getElementById('auth-save');
  var clearBtn = document.getElementById('auth-clear');

  function syncIcon() {
    toggle.classList.toggle('has-token', !!state.authToken);
  }
  syncIcon();

  input.value = state.authToken;

  toggle.onclick = function(e) {
    e.stopPropagation();
    dropdown.classList.toggle('open');
    if (dropdown.classList.contains('open')) input.focus();
  };

  saveBtn.onclick = function() {
    state.authToken = input.value.trim();
    localStorage.setItem('pk_auth_token', state.authToken);
    syncIcon();
    dropdown.classList.remove('open');
    showToast('Auth token saved');
  };

  clearBtn.onclick = function() {
    state.authToken = '';
    input.value = '';
    localStorage.removeItem('pk_auth_token');
    syncIcon();
    dropdown.classList.remove('open');
    showToast('Auth token cleared');
  };

  document.addEventListener('click', function(e) {
    if (!dropdown.contains(e.target) && e.target !== toggle) {
      dropdown.classList.remove('open');
    }
  });
})();

/* ── Design switcher ─────────────────────────────────────── */
(function() {
  var sel = document.getElementById('design-switcher');
  sel.value = 'v1';

  sel.onchange = function() {
    var v = sel.value;
    document.cookie = 'pk_design=' + v + '; path=/; max-age=31536000; SameSite=Lax';
    var pathname = window.location.pathname;
    var newPath = pathname.replace(/\/v[1-5]\/?$/, '/' + v + '/');
    if (newPath === pathname) {
      newPath = pathname.replace(/\/$/, '') + '/../' + v + '/';
    }
    window.location.href = newPath;
  };
})();

/* ── Version ─────────────────────────────────────────────── */
document.getElementById('version-badge').textContent = 'v__APP_VERSION__';

/* ── Tabs ────────────────────────────────────────────────── */
var TAB_NAMES = ['Dashboard', 'Printers', 'Discovery', 'Cards', 'Templates', 'Config', 'Help'];
var tabsEl = document.getElementById('tabs');
TAB_NAMES.forEach(function(name, i) {
  var btn = el('button', 'tab-btn' + (i === 0 ? ' active' : ''), name);
  btn.dataset.view = name.toLowerCase();
  btn.onclick = function() {
    document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
    btn.classList.add('active');
    document.getElementById('view-' + btn.dataset.view).classList.add('active');
    rebuildView(btn.dataset.view);
    animateCards();
  };
  tabsEl.appendChild(btn);
});

/* ── SVG icons ───────────────────────────────────────────── */
var ICONS = {
  printer: '<svg viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>',
  wifi: '<svg viewBox="0 0 24 24"><path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/></svg>',
  clock: '<svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>',
  search: '<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>'
};

/* ── Dashboard Bento ─────────────────────────────────────── */
function buildDashboard() {
  var grid = document.getElementById('bento-dashboard');
  grid.innerHTML = '';
  var h = state.health;
  if (!h) {
    grid.innerHTML = '<div class="card span-2" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">Loading...</p></div>';
    return;
  }

  var metrics = [
    { label: 'Printers', value: h.printer_count, sub: 'Configured', icon: 'printer' },
    { label: 'MQTT', value: h.mqtt && h.mqtt.connected ? 'Connected' : (h.mqtt && h.mqtt.enabled ? 'Disconnected' : 'Off'),
      sub: h.mqtt && h.mqtt.connected ? 'Publishing to ' + h.mqtt.host : (h.mqtt && h.mqtt.last_error ? h.mqtt.last_error : (h.mqtt && h.mqtt.enabled ? 'Connecting to ' + h.mqtt.host : 'No broker configured')), icon: 'wifi' },
    { label: 'Auto Print', value: h.auto_print_enabled ? 'On' : 'Off', sub: h.auto_print_enabled ? 'Scheduler active' : 'Disabled', icon: 'clock' },
    { label: 'Discovery', value: h.discovery.printer_count, sub: 'Found on network', icon: 'search' },
  ];

  metrics.forEach(function(m) {
    var c = el('div', 'card');
    c.innerHTML =
      '<div class="metric-icon">' + ICONS[m.icon] + '</div>' +
      '<div class="metric-label">' + escHtml(m.label) + '</div>' +
      '<div class="metric-value">' + escHtml(String(m.value)) + '</div>' +
      '<div class="metric-sub">' + escHtml(m.sub) + '</div>';
    grid.appendChild(c);
  });

  // Printer Health - span 3
  var healthCard = el('div', 'card span-3');
  var rows = '';
  h.printers.forEach(function(p) {
    var due = new Date(p.next_keepalive_due_at);
    var overdue = due < new Date();
    var ippBar = '';
    if (p.ha_ipp_entities) {
      var markers = p.ha_ipp_entities.filter(function(e) { return e.marker_type; });
      if (markers.length) {
        ippBar = '<div style="display:flex;gap:4px;margin-top:4px">';
        markers.forEach(function(m) {
          var pct = parseInt(m.state, 10) || 0;
          var c = pct > 50 ? 'var(--success)' : pct > 15 ? 'var(--warning)' : 'var(--danger)';
          var label = m.friendly_name.replace(/.*Series\s*/i, '').replace(/\s*ink$/i, '').replace(/\s*toner$/i, '');
          ippBar += '<div style="flex:1;min-width:0" title="' + escHtml(label) + ' ' + pct + '%"><div style="height:4px;border-radius:2px;background:var(--border)"><div style="width:' + pct + '%;height:100%;border-radius:2px;background:' + c + '"></div></div></div>';
        });
        ippBar += '</div>';
      }
    }
    rows +=
      '<div class="printer-row">' +
        '<div class="status-dot ' + escHtml(p.health_status) + '"></div>' +
        '<div class="printer-info">' +
          '<div class="printer-name">' + escHtml(p.name) + '</div>' +
          '<div class="printer-state">' + escHtml(p.printer_state) + ' &middot; ' + escHtml(p.template) + '</div>' +
          ippBar +
        '</div>' +
        '<div class="printer-due">' +
          '<div class="due-label">Next due</div>' +
          '<div style="color:' + (overdue ? '#ff453a' : 'inherit') + ';font-weight:' + (overdue ? '600' : '400') + '">' + escHtml(relTime(p.next_keepalive_due_at)) + '</div>' +
        '</div>' +
      '</div>';
  });
  healthCard.innerHTML = '<div class="card-title">Printer Health</div>' + rows;
  grid.appendChild(healthCard);

  // System Info
  var sysCard = el('div', 'card');
  sysCard.innerHTML =
    '<div class="card-title">System Info</div>' +
    '<ul class="kv-list">' +
      '<li class="kv-item"><span class="kv-key">Version</span><span class="kv-val">' + escHtml(h.version) + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Auth</span><span class="kv-val">' + (h.auth_required ? 'Required' : 'Open') + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Updated</span><span class="kv-val">' + escHtml(relTime(h.timestamp)) + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Templates</span><span class="kv-val">' + h.supported_templates.length + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Add-on</span><span class="kv-val" title="' + escHtml(h.addon_page_url || '') + '">HA Supervisor</span></li>' +
    '</ul>';
  grid.appendChild(sysCard);

  // Discovery Summary (span 2) + Quick Actions
  var discCard = el('div', 'card span-2');
  var d = h.discovery;
  discCard.innerHTML =
    '<div class="card-title">Discovery Summary</div>' +
    '<ul class="kv-list">' +
      '<li class="kv-item"><span class="kv-key">Status</span><span class="kv-val ' + (d.enabled ? 'ok' : '') + '">' + (d.enabled ? 'Enabled' : 'Disabled') + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Last Scan</span><span class="kv-val">' + escHtml(relTime(d.last_scan_at)) + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Duration</span><span class="kv-val">' + d.last_scan_duration_seconds + 's</span></li>' +
      '<li class="kv-item"><span class="kv-key">Candidates</span><span class="kv-val">' + d.printer_count + ' printers</span></li>' +
    '</ul>';
  grid.appendChild(discCard);

  var actCard = el('div', 'card');
  actCard.innerHTML =
    '<div class="card-title">Quick Actions</div>' +
    '<div class="quick-actions">' +
      '<button class="btn btn-primary" id="qa-refresh">Refresh Health</button>' +
      '<button class="btn btn-secondary" id="qa-rescan">Rescan Network</button>' +
      '<button class="btn btn-ghost" id="qa-open-ha">Open in HA</button>' +
    '</div>';
  grid.appendChild(actCard);

  // Bind quick actions
  document.getElementById('qa-refresh').onclick = function() { refreshAll(); };
  document.getElementById('qa-rescan').onclick = async function() {
    try {
      var resp = await requestJson('discovery/rescan', { method: 'POST', body: '{}' });
      state.discovery = resp;
      buildDiscovery();
      showToast('Rescan complete');
    } catch (e) { showToast('Rescan failed: ' + e.message, true); }
  };
  document.getElementById('qa-open-ha').onclick = function() {
    if (state.health && state.health.addon_page_url) {
      window.open(state.health.addon_page_url, '_blank');
    } else {
      showToast('Add-on URL not available', true);
    }
  };

  // About card
  var tipCard = el('div', 'card span-2');
  tipCard.innerHTML =
    '<div class="card-title">About Keepalive</div>' +
    '<p style="font-size:14px;color:var(--text-secondary);line-height:1.6">' +
      '__APP_NAME__ periodically sends small print jobs to prevent inkjet nozzles from drying out. ' +
      'Configure cadence per-printer and choose from multiple page templates.' +
    '</p>';
  grid.appendChild(tipCard);
}

/* ── Printers View ───────────────────────────────────────── */
function buildPrinters() {
  var container = document.getElementById('printer-cards');
  container.innerHTML = '';
  if (!state.health) {
    container.innerHTML = '<div class="card" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">Loading...</p></div>';
    return;
  }

  // Wire Add Printer header button
  var addBtn = document.getElementById('printers-add-btn-header');
  if (addBtn) addBtn.onclick = function() {
    document.querySelector('[data-view="config"]').click();
    setTimeout(function() {
      var sec = document.getElementById('cfg-sec-printers');
      if (sec) { sec.classList.remove('collapsed'); sec.scrollIntoView({ behavior: 'smooth' }); }
      var cfgAddBtn = document.getElementById('cfg-add-printer');
      if (cfgAddBtn) cfgAddBtn.click();
    }, 200);
  };

  if (!state.health.printers.length) {
    container.innerHTML += '<div class="card" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">No printers configured. Click "Add Printer" or add one from the Discovery tab.</p></div>';
    return;
  }

  state.health.printers.forEach(function(p) {
    var card = el('div', 'card');
    var opts = (state.health.supported_templates || []).map(function(t) {
      return '<option value="' + escHtml(t) + '"' + (t === p.template ? ' selected' : '') + '>' + escHtml(t.replace(/_/g, ' ')) + '</option>';
    }).join('');

    var origEnabled = p.enabled;
    var origCadence = Math.round(p.cadence_hours / 24);
    var origTemplate = p.template;

    card.innerHTML =
      '<div class="printer-card-header">' +
        '<div class="status-dot ' + escHtml(p.health_status) + '"></div>' +
        '<div>' +
          '<div class="printer-name">' + escHtml(p.name) + '</div>' +
          '<div class="printer-card-uri">' + escHtml(p.printer_uri) + '</div>' +
        '</div>' +
      '</div>' +
      '<div class="stats-grid">' +
        '<div class="stat-box"><div class="stat-label">Status</div><div class="stat-value">' + (p.health_status === 'ok' ? 'Healthy' : 'Needs attention') + '</div></div>' +
        '<div class="stat-box"><div class="stat-label">State</div><div class="stat-value" style="text-transform:capitalize">' + escHtml(p.printer_state) + '</div></div>' +
        '<div class="stat-box"><div class="stat-label">Last Print</div><div class="stat-value">' + escHtml(relTime(p.last_print_at)) + '</div></div>' +
        '<div class="stat-box"><div class="stat-label">Next Due</div><div class="stat-value">' + escHtml(relTime(p.next_keepalive_due_at)) + '</div></div>' +
      '</div>' +
      (p.ha_ipp_entities ? (function() {
        var ipp = p.ha_ipp_entities;
        var main = ipp.find(function(e) { return !e.marker_type; });
        var markers = ipp.filter(function(e) { return e.marker_type; });
        var html = '<div style="margin:12px 0;padding:10px 12px;background:var(--accent-subtle);border:1px solid var(--accent-border);border-radius:var(--radius-sm)">' +
          '<div style="font-size:11px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Native HA IPP Integration</div>';
        if (main) {
          html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:4px">' + escHtml(main.friendly_name) + ' — <span style="text-transform:capitalize">' + escHtml(main.state) + '</span></div>';
        }
        if (markers.length) {
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
          markers.forEach(function(m) {
            var label = m.friendly_name.replace(/.*Series\s*/i, '').replace(/\s*ink$/i, '').replace(/\s*toner$/i, '');
            var pct = parseInt(m.state, 10) || 0;
            var color = pct > 50 ? 'var(--success)' : pct > 15 ? 'var(--warning)' : 'var(--danger)';
            html += '<div style="flex:1;min-width:60px;text-align:center">' +
              '<div style="font-size:11px;color:var(--muted)">' + escHtml(label) + '</div>' +
              '<div style="margin-top:2px;height:6px;border-radius:3px;background:var(--border)">' +
                '<div style="width:' + pct + '%;height:100%;border-radius:3px;background:' + color + '"></div>' +
              '</div>' +
              '<div style="font-size:11px;font-weight:600;color:var(--text);margin-top:2px">' + pct + '%</div>' +
            '</div>';
          });
          html += '</div>';
        }
        html += '</div>';
        return html;
      })() : '') +
      '<div class="control-row">' +
        '<label><input type="checkbox" class="p-enabled"' + (p.enabled ? ' checked' : '') + '> Enabled</label>' +
        '<label>Cadence <input type="number" class="p-cadence" value="' + origCadence + '" min="1"> days</label>' +
        '<select class="p-template">' + opts + '</select>' +
      '</div>' +
      '<div class="btn-row">' +
        '<button class="btn btn-primary btn-save" disabled>Save</button>' +
        '<button class="btn btn-secondary btn-print-now" title="Print a keepalive page only if one is due based on the cadence schedule">Print if Due</button>' +
        '<button class="btn btn-ghost btn-force" title="Print a keepalive page immediately regardless of schedule">Force Print</button>' +
        '<button class="btn btn-ghost btn-poll" title="Query the printer\'s IPP attributes to refresh status, ink levels, and job counts">Poll Status</button>' +
        '<button class="btn btn-ghost btn-remove" title="Remove this printer from configuration" style="color:var(--danger);margin-left:auto">Remove</button>' +
      '</div>';

    var pid = p.printer_id;
    var saveBtn = card.querySelector('.btn-save');

    // Track changes to enable Save
    function checkDirty() {
      var dirty = card.querySelector('.p-enabled').checked !== origEnabled ||
        parseInt(card.querySelector('.p-cadence').value, 10) !== origCadence ||
        card.querySelector('.p-template').value !== origTemplate;
      saveBtn.disabled = !dirty;
    }
    card.querySelector('.p-enabled').addEventListener('change', checkDirty);
    card.querySelector('.p-cadence').addEventListener('input', checkDirty);
    card.querySelector('.p-template').addEventListener('change', checkDirty);

    saveBtn.onclick = async function() {
      var enabled = card.querySelector('.p-enabled').checked;
      var cadence = (parseInt(card.querySelector('.p-cadence').value, 10) || 7) * 24;
      var template = card.querySelector('.p-template').value;
      try {
        await requestJson('printers/' + encodeURIComponent(pid) + '/settings', {
          method: 'POST',
          body: JSON.stringify({ enabled: enabled, cadence_hours: cadence, template: template })
        });
        showToast('Settings saved for ' + p.name);
        refreshAll();
      } catch (e) { showToast('Save failed: ' + e.message, true); }
    };

    card.querySelector('.btn-print-now').onclick = async function() {
      var template = card.querySelector('.p-template').value;
      try {
        await requestJson('printers/' + encodeURIComponent(pid) + '/print', {
          method: 'POST',
          body: JSON.stringify({ template: template, force: false })
        });
        showToast('Print sent to ' + p.name);
        refreshAll();
      } catch (e) { showToast('Print failed: ' + e.message, true); }
    };

    card.querySelector('.btn-force').onclick = async function() {
      var template = card.querySelector('.p-template').value;
      try {
        await requestJson('printers/' + encodeURIComponent(pid) + '/print', {
          method: 'POST',
          body: JSON.stringify({ template: template, force: true })
        });
        showToast('Force print sent to ' + p.name);
        refreshAll();
      } catch (e) { showToast('Force print failed: ' + e.message, true); }
    };

    card.querySelector('.btn-poll').onclick = async function() {
      try {
        await requestJson('printers/' + encodeURIComponent(pid) + '/poll', {
          method: 'POST',
          body: '{}'
        });
        showToast('Poll sent to ' + p.name);
        refreshAll();
      } catch (e) { showToast('Poll failed: ' + e.message, true); }
    };

    card.querySelector('.btn-remove').onclick = async function() {
      if (!confirm('Remove "' + p.name + '" from configuration?')) return;
      try {
        await requestJson('printers/' + encodeURIComponent(pid) + '/delete', {
          method: 'POST',
          body: '{}'
        });
        showToast(p.name + ' removed');
        refreshAll();
      } catch (e) { showToast('Remove failed: ' + e.message, true); }
    };

    container.appendChild(card);
  });
}

/* ── Discovery View ──────────────────────────────────────── */
function buildDiscovery() {
  var container = document.getElementById('discovery-content');
  container.innerHTML = '';
  var d = state.discovery;
  if (!d) {
    container.innerHTML = '<div class="card" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">Loading...</p></div>';
    return;
  }

  var statsCard = el('div', 'card',
    '<div class="card-title">Scan Summary</div>' +
    '<ul class="kv-list">' +
      '<li class="kv-item"><span class="kv-key">Status</span><span class="kv-val ' + (d.enabled ? 'ok' : '') + '">' + (d.enabled ? 'Enabled' : 'Disabled') + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Last Scan</span><span class="kv-val">' + escHtml(shortDate(d.last_scan_at)) + '</span></li>' +
      '<li class="kv-item"><span class="kv-key">Duration</span><span class="kv-val">' + d.last_scan_duration_seconds + 's</span></li>' +
      '<li class="kv-item"><span class="kv-key">Found</span><span class="kv-val">' + d.printer_count + ' printers</span></li>' +
    '</ul>' +
    '<div style="margin-top:16px"><button class="btn btn-secondary" id="disc-rescan-btn">Rescan Now</button></div>'
  );
  statsCard.style.marginBottom = '16px';
  container.appendChild(statsCard);

  document.getElementById('disc-rescan-btn').onclick = async function() {
    try {
      var resp = await requestJson('discovery/rescan', { method: 'POST', body: '{}' });
      state.discovery = resp;
      buildDiscovery();
      showToast('Rescan complete');
      animateCards();
    } catch (e) { showToast('Rescan failed: ' + e.message, true); }
  };

  var tableRows = (d.printers || []).map(function(p, idx) {
    var configCell;
    if (p.already_configured) {
      configCell = '<span class="pill pill-blue">Configured</span>';
    } else {
      configCell = '<button class="btn btn-primary disc-add-btn" style="font-size:12px;padding:4px 12px;" data-disc-idx="' + idx + '">Add</button>';
    }
    var typeVal = p.printer_type_guess || 'inkjet';
    var typeCell = p.already_configured
      ? '<td>' + escHtml(typeVal) + '</td>'
      : '<td><select class="disc-type-select" data-disc-idx="' + idx + '" style="font-size:12px;padding:2px 4px;">' +
          '<option value="inkjet"' + (typeVal === 'inkjet' ? ' selected' : '') + '>inkjet</option>' +
          '<option value="laser"' + (typeVal === 'laser' ? ' selected' : '') + '>laser</option>' +
        '</select></td>';
    var displayUri = p.uri || '';
    var printerCell = '<td style="min-width:180px"><div style="font-weight:600;margin-bottom:2px">' + escHtml(p.printer_name) + '</div>' +
      '<div class="mono" style="font-size:11px;opacity:.7">' + escHtml(displayUri) + '</div></td>';
    var ippsCell = '<td>';
    if (p.ipps_available) {
      var checked = (p.suggested_config && p.suggested_config.printer_uri && p.suggested_config.printer_uri.startsWith('ipps://')) ? ' checked' : '';
      ippsCell += '<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px"><input type="checkbox" class="disc-ipps-toggle" data-disc-idx="' + idx + '"' + checked + '> IPPS</label>';
    } else {
      ippsCell += '<span style="opacity:.4;font-size:12px">\u2014</span>';
    }
    ippsCell += '</td>';
    return '<tr>' +
      printerCell +
      '<td>' + escHtml(p.printer_make_and_model || '\u2014') + '</td>' +
      '<td>' + escHtml(p.printer_state || '\u2014') + '</td>' +
      typeCell +
      ippsCell +
      '<td>' + (p.reachable ? '<span class="pill pill-green">Online</span>' : '<span class="pill pill-red">Offline</span>') + '</td>' +
      '<td>' + configCell + '</td>' +
    '</tr>';
  }).join('');

  var tableCard = el('div', 'card',
    '<div class="card-title">Discovered Printers</div>' +
    '<div style="overflow-x:auto">' +
      '<table class="disc-table">' +
        '<thead><tr><th>Printer</th><th>Model</th><th>State</th><th>Type</th><th>Secure</th><th>Status</th><th>Config</th></tr></thead>' +
        '<tbody>' + tableRows + '</tbody>' +
      '</table>' +
    '</div>'
  );
  container.appendChild(tableCard);

  tableCard.querySelectorAll('.disc-type-select').forEach(function(sel) {
    sel.addEventListener('change', function() {
      var idx = parseInt(sel.getAttribute('data-disc-idx'), 10);
      var p = d.printers[idx];
      if (p && p.suggested_config) {
        p.suggested_config.printer_type = sel.value;
        p.suggested_config.cadence_hours = sel.value === 'laser' ? 720 : 168;
      }
    });
  });

  tableCard.querySelectorAll('.disc-ipps-toggle').forEach(function(cb) {
    cb.addEventListener('change', function() {
      var idx = parseInt(cb.getAttribute('data-disc-idx'), 10);
      var p = d.printers[idx];
      if (p && p.suggested_config) {
        p.suggested_config.printer_uri = cb.checked ? (p.ipps_uri || p.uri) : (p.ipp_uri || p.uri);
      }
    });
  });

  tableCard.querySelectorAll('.disc-add-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      var idx = parseInt(btn.getAttribute('data-disc-idx'), 10);
      var p = d.printers[idx];
      btn.disabled = true;
      btn.textContent = 'Adding...';
      try {
        var typeSelect = tableCard.querySelector('.disc-type-select[data-disc-idx="' + idx + '"]');
        if (typeSelect) {
          p.suggested_config.printer_type = typeSelect.value;
          p.suggested_config.cadence_hours = typeSelect.value === 'laser' ? 720 : 168;
        }
        var ippsToggle = tableCard.querySelector('.disc-ipps-toggle[data-disc-idx="' + idx + '"]');
        if (ippsToggle) {
          p.suggested_config.printer_uri = ippsToggle.checked ? (p.ipps_uri || p.uri) : (p.ipp_uri || p.uri);
        }
        var cfgResp = await requestJson('config');
        var opts = cfgResp.options || {};
        if (!Array.isArray(opts.printers)) opts.printers = [];
        opts.printers.push(p.suggested_config);
        await requestJson('config', { method: 'POST', body: JSON.stringify({ options: opts }) });
        showToast('Added ' + p.printer_name + ' to config.');
        refreshAll();
      } catch (e) {
        btn.disabled = false;
        btn.textContent = 'Add';
        showToast('Failed to add printer: ' + e.message, true);
      }
    });
  });
}

/* ── Config View ─────────────────────────────────────────── */
var configCurrentMode = 'form';
var configRawObj = {};

var TEMPLATE_OPTIONS = ['color_bars', 'home_summary', 'weather_snapshot', 'entity_report', 'hybrid', 'daily_summary'];
var PRINTER_TYPE_OPTIONS = ['inkjet', 'laser'];

function makeToggleField(key, label, desc) {
  return '<div class="cfg-field">' +
    '<div class="cfg-toggle-wrap">' +
      '<label class="cfg-toggle"><input type="checkbox" data-key="' + escHtml(key) + '"><span class="cfg-toggle-track"></span></label>' +
      '<span class="cfg-field-label" style="margin-bottom:0">' + escHtml(label) + '</span>' +
    '</div>' +
    (desc ? '<div class="cfg-field-desc">' + escHtml(desc) + '</div>' : '') +
  '</div>';
}

function makeTextField(key, label, desc, type) {
  type = type || 'text';
  return '<div class="cfg-field">' +
    '<label class="cfg-field-label">' + escHtml(label) + '</label>' +
    '<input type="' + type + '" data-key="' + escHtml(key) + '">' +
    (desc ? '<div class="cfg-field-desc">' + escHtml(desc) + '</div>' : '') +
  '</div>';
}

function makeNumberField(key, label, desc, min, max, suffix) {
  return '<div class="cfg-field">' +
    '<label class="cfg-field-label">' + escHtml(label) + '</label>' +
    '<div class="cfg-field-inline">' +
      '<input type="number" data-key="' + escHtml(key) + '"' +
        (min !== undefined ? ' min="' + min + '"' : '') +
        (max !== undefined ? ' max="' + max + '"' : '') + '>' +
      (suffix ? '<span class="cfg-field-suffix">' + escHtml(suffix) + '</span>' : '') +
    '</div>' +
    (desc ? '<div class="cfg-field-desc">' + escHtml(desc) + '</div>' : '') +
  '</div>';
}

function makeSelectField(key, label, desc, options) {
  var opts = options.map(function(o) {
    return '<option value="' + escHtml(o) + '">' + escHtml(o.replace(/_/g, ' ')) + '</option>';
  }).join('');
  return '<div class="cfg-field">' +
    '<label class="cfg-field-label">' + escHtml(label) + '</label>' +
    '<select data-key="' + escHtml(key) + '">' + opts + '</select>' +
    (desc ? '<div class="cfg-field-desc">' + escHtml(desc) + '</div>' : '') +
  '</div>';
}

function makeTextareaField(key, label, desc) {
  return '<div class="cfg-field">' +
    '<label class="cfg-field-label">' + escHtml(label) + '</label>' +
    '<textarea data-key="' + escHtml(key) + '"></textarea>' +
    (desc ? '<div class="cfg-field-desc">' + escHtml(desc) + '</div>' : '') +
  '</div>';
}

function makeSection(id, title, bodyHtml, collapsed, desc, summary) {
  return '<div class="cfg-section' + (collapsed ? ' collapsed' : '') + '" id="cfg-sec-' + id + '">' +
    '<div class="cfg-section-header">' +
      '<div>' +
        '<span class="cfg-section-title">' + escHtml(title) + '</span>' +
        (summary ? '<span class="cfg-section-summary" id="cfg-summary-' + id + '" style="margin-left:8px;font-size:12px;opacity:.6"></span>' : '') +
        (desc ? '<div class="cfg-section-desc">' + escHtml(desc) + ' <a href="#" onclick="event.preventDefault();event.stopPropagation();document.querySelector(\'[data-view=help]\').click()">Learn more</a></div>' : '') +
      '</div>' +
      '<span class="cfg-section-chevron">&#9660;</span>' +
    '</div>' +
    '<div class="cfg-section-body">' + bodyHtml + '</div>' +
  '</div>';
}

function buildPrinterCard(index, collapsed) {
  var prefix = 'printer-' + index;
  return '<div class="cfg-printer-card' + (collapsed ? ' collapsed' : '') + '" data-printer-index="' + index + '">' +
    '<div class="cfg-printer-header">' +
      '<span class="cfg-printer-name">Printer ' + (index + 1) + '</span>' +
      '<button class="cfg-printer-remove" data-printer-remove="' + index + '">Remove</button>' +
    '</div>' +
    '<div class="cfg-printer-body">' +
      makeTextField(prefix + '.name', 'Name', 'Friendly name shown in Home Assistant') +
      makeTextField(prefix + '.printer_uri', 'Printer URI', 'e.g. ipp://192.168.1.50/ipp/print') +
      makeTextField(prefix + '.id', 'ID', 'Optional stable ID (slug)') +
      makeSelectField(prefix + '.printer_type', 'Type', 'Used for maintenance guidance', PRINTER_TYPE_OPTIONS) +
      makeToggleField(prefix + '.enabled', 'Enabled', 'Participate in scheduled keepalive') +
      makeNumberField(prefix + '.cadence_hours', 'Cadence', 'Days between keepalive prints', 1, 30, 'days') +
      makeSelectField(prefix + '.template', 'Template', '', TEMPLATE_OPTIONS) +
      makeTextField(prefix + '.weather_entity', 'Weather Entity', '') +
      makeTextareaField(prefix + '.entity_ids', 'Entity IDs', 'One entity ID per line') +
      makeTextField(prefix + '.title', 'Page Title', '') +
      makeTextField(prefix + '.footer', 'Page Footer', '') +
    '</div>' +
  '</div>';
}

function buildConfigForm() {
  var formView = document.getElementById('config-form-view');
  var isSupervisor = state.health && state.health.is_supervisor;

  // Section 1: Printers
  var printersBody = '<div id="cfg-printers-list"></div>' +
    '<button class="btn btn-secondary" id="cfg-add-printer" style="margin-top:8px">+ Add Printer</button>';

  // Section 2: Scheduling
  var schedBody =
    makeToggleField('auto_print_enabled', 'Enable Internal Scheduler', '') +
    makeNumberField('status_poll_interval_minutes', 'Status Poll Interval', '', 1, 1440, 'min') +
    makeNumberField('failure_retry_minutes', 'Failure Cooldown', '', 1, 1440, 'min');

  // Section 3: Discovery
  var discBody =
    makeToggleField('discovery_enabled', 'Enable Discovery', '') +
    makeNumberField('discovery_interval_minutes', 'Scan Interval', '', 1, 1440, 'min') +
    makeNumberField('discovery_timeout_seconds', 'Scan Timeout', '', 1, 30, 'sec') +
    makeNumberField('discovery_ipp_query_timeout_seconds', 'IPP Query Timeout', '', 1, 30, 'sec') +
    makeToggleField('discovery_include_ipps', 'Include IPPS', '');

  // Section 4: Templates & Content
  var tplBody =
    makeSelectField('default_template', 'Default Template', '', TEMPLATE_OPTIONS) +
    makeTextField('title', 'Default Page Title', '') +
    makeTextField('footer', 'Default Page Footer', '') +
    makeTextField('weather_entity', 'Default Weather Entity', '') +
    makeTextareaField('entity_ids', 'Default Entity IDs', 'One entity ID per line');

  // Section 5: MQTT (Supervisor installs)
  var mqttBody, mqttDesc;
  if (isSupervisor) {
    mqttBody =
      makeToggleField('mqtt.enabled', 'Enable MQTT', '') +
      makeTextField('mqtt.discovery_prefix', 'Discovery Prefix', '') +
      makeTextField('mqtt.topic_prefix', 'Topic Prefix', '') +
      makeToggleField('mqtt.retain', 'Retain Messages', '') +
      makeTextField('mqtt.client_id', 'Client ID', '');
    mqttDesc = 'Exposes printers as Home Assistant devices via the Mosquitto broker. Connection settings are auto-detected from the Supervisor MQTT service.';
  } else {
    mqttBody =
      makeToggleField('mqtt.enabled', 'Enable MQTT', '') +
      makeTextField('mqtt.host', 'Host', 'e.g. core-mosquitto or your broker address') +
      makeNumberField('mqtt.port', 'Port', '', 1, 65535, '') +
      makeTextField('mqtt.username', 'Username', '') +
      makeTextField('mqtt.password', 'Password', '', 'password') +
      makeTextField('mqtt.discovery_prefix', 'Discovery Prefix', '') +
      makeTextField('mqtt.topic_prefix', 'Topic Prefix', '') +
      makeToggleField('mqtt.retain', 'Retain Messages', '') +
      makeToggleField('mqtt.tls', 'Use TLS', '') +
      makeTextField('mqtt.client_id', 'Client ID', '');
    mqttDesc = 'Exposes printers as Home Assistant devices via MQTT discovery. Configure your broker connection details below.';
  }

  // Section 6: Integration (non-Supervisor installs)
  var intBody, intDesc;
  if (isSupervisor) {
    intBody =
      '<div class="cfg-field"><div class="cfg-field-desc" style="padding:8px 0;opacity:.7">Running as a Supervisor add-on \u2014 Home Assistant connection is handled automatically. API auth and add-on URL can be configured in the advanced (JSON) editor if needed.</div></div>' +
      makeTextField('addon_page_url', 'Add-on Page URL', 'URL for printed QR code (auto-detected if blank)') +
      makeTextField('auth_token', 'API Auth Token', 'Optional bearer token for API callers', 'password');
    intDesc = 'Home Assistant connection is managed by the Supervisor.';
  } else {
    intBody =
      makeTextField('ha_url', 'Home Assistant URL', 'e.g. http://homeassistant:8123') +
      makeTextField('ha_token', 'Long-Lived Access Token', '', 'password') +
      makeTextField('addon_page_url', 'Add-on Page URL', 'URL for printed QR code') +
      makeTextField('auth_token', 'API Auth Token', 'Optional bearer token for API callers', 'password');
    intDesc = 'Connect to Home Assistant for entity data in printed templates. Required for non-Supervisor installs.';
  }

  formView.innerHTML =
    makeSection('printers', 'Printers', printersBody, false, 'Define your printers with individual URIs, types, and print schedules.', true) +
    makeSection('scheduling', 'Scheduling', schedBody, true, 'Controls the auto-print scheduler and IPP polling frequency.', true) +
    makeSection('discovery', 'Discovery', discBody, true, 'Network scanning for printers via mDNS/DNS-SD.', true) +
    makeSection('templates', 'Templates & Content', tplBody, true, 'Default template and content settings for printed pages.', false) +
    makeSection('mqtt', 'MQTT', mqttBody, true, mqttDesc, true) +
    makeSection('integration', 'Integration', intBody, true, intDesc, false);

  // Bind section toggles
  formView.querySelectorAll('.cfg-section-header').forEach(function(hdr) {
    hdr.addEventListener('click', function() {
      hdr.parentElement.classList.toggle('collapsed');
    });
  });

  // Bind add printer
  document.getElementById('cfg-add-printer').addEventListener('click', function() {
    addPrinterCard({});
  });
}

function updateConfigSummaries() {
  var h = state.health;
  var c = state.config;
  if (!h) return;
  // Printers
  var ps = document.getElementById('cfg-summary-printers');
  if (ps) ps.textContent = h.printer_count + ' printer' + (h.printer_count !== 1 ? 's' : '');
  // Scheduling
  var ss = document.getElementById('cfg-summary-scheduling');
  if (ss) ss.textContent = h.auto_print_enabled ? 'Active' : 'Disabled';
  // Discovery
  var ds = document.getElementById('cfg-summary-discovery');
  if (ds) {
    var disc = h.discovery || {};
    ds.textContent = disc.enabled !== false ? (disc.printer_count || 0) + ' found' : 'Disabled';
  }
  // MQTT
  var ms = document.getElementById('cfg-summary-mqtt');
  if (ms) ms.textContent = h.mqtt_enabled ? 'Connected' : 'Disabled';
}

function addPrinterCard(printerData, collapsed) {
  var list = document.getElementById('cfg-printers-list');
  var index = list.querySelectorAll('.cfg-printer-card').length;
  var tmp = document.createElement('div');
  tmp.innerHTML = buildPrinterCard(index, collapsed);
  var card = tmp.firstChild;
  list.appendChild(card);

  // Populate card fields
  var prefix = 'printer-' + index;
  setFieldValue(card, prefix + '.name', printerData.name || '');
  setFieldValue(card, prefix + '.printer_uri', printerData.printer_uri || '');
  setFieldValue(card, prefix + '.id', printerData.id || '');
  setFieldValue(card, prefix + '.printer_type', printerData.printer_type || 'inkjet');
  setFieldValue(card, prefix + '.enabled', printerData.enabled !== false);
  setFieldValue(card, prefix + '.cadence_hours', Math.round((printerData.cadence_hours || 72) / 24));
  setFieldValue(card, prefix + '.template', printerData.template || 'color_bars');
  setFieldValue(card, prefix + '.weather_entity', printerData.weather_entity || '');
  setFieldValue(card, prefix + '.entity_ids', printerData.entity_ids || []);
  setFieldValue(card, prefix + '.title', printerData.title || '');
  setFieldValue(card, prefix + '.footer', printerData.footer || '');

  // Update the name label
  var nameLabel = card.querySelector('.cfg-printer-name');
  nameLabel.textContent = printerData.name || ('Printer ' + (index + 1));

  // Bind header toggle
  card.querySelector('.cfg-printer-header').addEventListener('click', function(e) {
    if (e.target.classList.contains('cfg-printer-remove')) return;
    card.classList.toggle('collapsed');
  });

  // Bind remove
  card.querySelector('.cfg-printer-remove').addEventListener('click', function(e) {
    e.stopPropagation();
    card.remove();
    reindexPrinterCards();
  });

  // Update name label on name change
  var nameInput = card.querySelector('[data-key="' + prefix + '.name"]');
  if (nameInput) {
    nameInput.addEventListener('input', function() {
      nameLabel.textContent = nameInput.value || ('Printer ' + (index + 1));
    });
  }
}

function reindexPrinterCards() {
  var list = document.getElementById('cfg-printers-list');
  var cards = list.querySelectorAll('.cfg-printer-card');
  cards.forEach(function(card, i) {
    var oldIndex = parseInt(card.getAttribute('data-printer-index'), 10);
    card.setAttribute('data-printer-index', i);
    card.querySelectorAll('[data-key]').forEach(function(field) {
      var key = field.getAttribute('data-key');
      field.setAttribute('data-key', key.replace('printer-' + oldIndex + '.', 'printer-' + i + '.'));
    });
    card.querySelector('.cfg-printer-remove').setAttribute('data-printer-remove', i);
  });
}

function setFieldValue(scope, key, value) {
  var field = scope.querySelector('[data-key="' + key + '"]');
  if (!field) return;
  if (field.type === 'checkbox') {
    field.checked = !!value;
  } else if (field.tagName === 'TEXTAREA') {
    field.value = Array.isArray(value) ? value.join('\n') : (value || '');
  } else if (field.type === 'number') {
    field.value = (value !== undefined && value !== null) ? Number(value) : '';
  } else {
    field.value = value || '';
  }
}

function getFieldValue(scope, key) {
  var field = scope.querySelector('[data-key="' + key + '"]');
  if (!field) return undefined;
  if (field.type === 'checkbox') return field.checked;
  if (field.type === 'number') return field.value !== '' ? Number(field.value) : undefined;
  if (field.tagName === 'TEXTAREA') {
    return field.value.split('\n').map(function(s) { return s.trim(); }).filter(function(s) { return s; });
  }
  return field.value;
}

function populateForm(config) {
  var formView = document.getElementById('config-form-view');

  // Printers
  var list = document.getElementById('cfg-printers-list');
  list.innerHTML = '';
  var printers = config.printers || [];
  printers.forEach(function(p, i) {
    addPrinterCard(p, i > 0);
  });

  // Scheduling
  setFieldValue(formView, 'auto_print_enabled', config.auto_print_enabled);
  setFieldValue(formView, 'status_poll_interval_minutes', config.status_poll_interval_minutes);
  setFieldValue(formView, 'failure_retry_minutes', config.failure_retry_minutes);

  // Discovery
  setFieldValue(formView, 'discovery_enabled', config.discovery_enabled);
  setFieldValue(formView, 'discovery_interval_minutes', config.discovery_interval_minutes);
  setFieldValue(formView, 'discovery_timeout_seconds', config.discovery_timeout_seconds);
  setFieldValue(formView, 'discovery_ipp_query_timeout_seconds', config.discovery_ipp_query_timeout_seconds);
  setFieldValue(formView, 'discovery_include_ipps', config.discovery_include_ipps);

  // Templates
  setFieldValue(formView, 'default_template', config.default_template);
  setFieldValue(formView, 'title', config.title);
  setFieldValue(formView, 'footer', config.footer);
  setFieldValue(formView, 'weather_entity', config.weather_entity);
  setFieldValue(formView, 'entity_ids', config.entity_ids);

  // MQTT
  var mqtt = config.mqtt || {};
  setFieldValue(formView, 'mqtt.enabled', mqtt.enabled);
  setFieldValue(formView, 'mqtt.host', mqtt.host);
  setFieldValue(formView, 'mqtt.port', mqtt.port);
  setFieldValue(formView, 'mqtt.username', mqtt.username);
  setFieldValue(formView, 'mqtt.password', mqtt.password);
  setFieldValue(formView, 'mqtt.discovery_prefix', mqtt.discovery_prefix);
  setFieldValue(formView, 'mqtt.topic_prefix', mqtt.topic_prefix);
  setFieldValue(formView, 'mqtt.retain', mqtt.retain);
  setFieldValue(formView, 'mqtt.tls', mqtt.tls);
  setFieldValue(formView, 'mqtt.client_id', mqtt.client_id);

  // Integration
  setFieldValue(formView, 'ha_url', config.ha_url);
  setFieldValue(formView, 'ha_token', config.ha_token);
  setFieldValue(formView, 'addon_page_url', config.addon_page_url);
  setFieldValue(formView, 'auth_token', config.auth_token);
}

function serializeForm() {
  var formView = document.getElementById('config-form-view');
  var config = {};

  // Printers
  var printerCards = document.querySelectorAll('#cfg-printers-list .cfg-printer-card');
  config.printers = [];
  printerCards.forEach(function(card, i) {
    var prefix = 'printer-' + i;
    var p = {};
    p.name = getFieldValue(card, prefix + '.name');
    p.printer_uri = getFieldValue(card, prefix + '.printer_uri');
    var id = getFieldValue(card, prefix + '.id');
    if (id) p.id = id;
    p.printer_type = getFieldValue(card, prefix + '.printer_type');
    p.enabled = getFieldValue(card, prefix + '.enabled');
    p.cadence_hours = getFieldValue(card, prefix + '.cadence_hours') * 24;
    p.template = getFieldValue(card, prefix + '.template');
    var we = getFieldValue(card, prefix + '.weather_entity');
    if (we) p.weather_entity = we;
    var eids = getFieldValue(card, prefix + '.entity_ids');
    if (eids && eids.length) p.entity_ids = eids;
    var title = getFieldValue(card, prefix + '.title');
    if (title) p.title = title;
    var footer = getFieldValue(card, prefix + '.footer');
    if (footer) p.footer = footer;
    config.printers.push(p);
  });

  // Scheduling
  config.auto_print_enabled = getFieldValue(formView, 'auto_print_enabled');
  var spim = getFieldValue(formView, 'status_poll_interval_minutes');
  if (spim !== undefined) config.status_poll_interval_minutes = spim;
  var frm = getFieldValue(formView, 'failure_retry_minutes');
  if (frm !== undefined) config.failure_retry_minutes = frm;

  // Discovery
  config.discovery_enabled = getFieldValue(formView, 'discovery_enabled');
  var dim = getFieldValue(formView, 'discovery_interval_minutes');
  if (dim !== undefined) config.discovery_interval_minutes = dim;
  var dts = getFieldValue(formView, 'discovery_timeout_seconds');
  if (dts !== undefined) config.discovery_timeout_seconds = dts;
  var diqt = getFieldValue(formView, 'discovery_ipp_query_timeout_seconds');
  if (diqt !== undefined) config.discovery_ipp_query_timeout_seconds = diqt;
  config.discovery_include_ipps = getFieldValue(formView, 'discovery_include_ipps');

  // Templates
  config.default_template = getFieldValue(formView, 'default_template');
  var title = getFieldValue(formView, 'title');
  if (title) config.title = title;
  var footer = getFieldValue(formView, 'footer');
  if (footer) config.footer = footer;
  var we = getFieldValue(formView, 'weather_entity');
  if (we) config.weather_entity = we;
  var eids = getFieldValue(formView, 'entity_ids');
  if (eids && eids.length) config.entity_ids = eids;

  // MQTT - merge with existing config to preserve fields hidden in Supervisor mode
  config.mqtt = Object.assign({}, (configRawObj && configRawObj.mqtt) || {});
  var mqttEnabled = getFieldValue(formView, 'mqtt.enabled');
  if (mqttEnabled !== undefined) config.mqtt.enabled = mqttEnabled;
  var mh = getFieldValue(formView, 'mqtt.host');
  if (mh !== undefined) config.mqtt.host = mh;
  var mp = getFieldValue(formView, 'mqtt.port');
  if (mp !== undefined) config.mqtt.port = mp;
  var mu = getFieldValue(formView, 'mqtt.username');
  if (mu !== undefined) config.mqtt.username = mu;
  var mpw = getFieldValue(formView, 'mqtt.password');
  if (mpw !== undefined) config.mqtt.password = mpw;
  var mdp = getFieldValue(formView, 'mqtt.discovery_prefix');
  if (mdp !== undefined) config.mqtt.discovery_prefix = mdp;
  var mtp = getFieldValue(formView, 'mqtt.topic_prefix');
  if (mtp !== undefined) config.mqtt.topic_prefix = mtp;
  var mr = getFieldValue(formView, 'mqtt.retain');
  if (mr !== undefined) config.mqtt.retain = mr;
  var mt = getFieldValue(formView, 'mqtt.tls');
  if (mt !== undefined) config.mqtt.tls = mt;
  var mci = getFieldValue(formView, 'mqtt.client_id');
  if (mci !== undefined) config.mqtt.client_id = mci;

  // Integration - preserve existing values for hidden fields
  var haUrl = getFieldValue(formView, 'ha_url');
  if (haUrl !== undefined) config.ha_url = haUrl; else if (configRawObj.ha_url) config.ha_url = configRawObj.ha_url;
  var haToken = getFieldValue(formView, 'ha_token');
  if (haToken !== undefined) config.ha_token = haToken; else if (configRawObj.ha_token) config.ha_token = configRawObj.ha_token;
  var apUrl = getFieldValue(formView, 'addon_page_url');
  if (apUrl !== undefined) config.addon_page_url = apUrl;
  var at = getFieldValue(formView, 'auth_token');
  if (at !== undefined) config.auth_token = at;

  return config;
}

function syncFormToRaw() {
  var config = serializeForm();
  var textarea = document.getElementById('config-textarea');
  if (textarea) textarea.value = JSON.stringify(config, null, 2);
}

function syncRawToForm() {
  var textarea = document.getElementById('config-textarea');
  if (!textarea || !textarea.value.trim()) return;
  try {
    var config = JSON.parse(textarea.value);
    populateForm(config);
  } catch (e) {
    showToast('Invalid JSON in editor: ' + e.message, true);
  }
}

function buildConfig() {
  // Build raw view
  var rawView = document.getElementById('config-raw-view');
  rawView.innerHTML =
    '<div class="card" style="opacity:1;transform:none">' +
      '<div class="card-title">Raw JSON Configuration</div>' +
      '<textarea class="config-editor" id="config-textarea" placeholder="Click Load Config to fetch current configuration..."></textarea>' +
    '</div>';

  // Build form view
  buildConfigForm();

  // Mode toggle
  document.querySelectorAll('.config-mode-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var mode = btn.getAttribute('data-mode');
      document.querySelectorAll('.config-mode-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var formView = document.getElementById('config-form-view');
      var rawViewEl = document.getElementById('config-raw-view');
      if (mode === 'form') {
        syncRawToForm();
        formView.style.display = '';
        rawViewEl.style.display = 'none';
        configCurrentMode = 'form';
      } else {
        syncFormToRaw();
        formView.style.display = 'none';
        rawViewEl.style.display = '';
        configCurrentMode = 'advanced';
      }
    });
  });

  // Load button
  document.getElementById('cfg-load').onclick = async function() {
    try {
      var resp = await requestJson('config');
      configRawObj = resp.options || {};
      document.getElementById('config-textarea').value = JSON.stringify(configRawObj, null, 2);
      populateForm(configRawObj);
      showToast('Config loaded');
    } catch (e) { showToast('Load failed: ' + e.message, true); }
  };

  // Save button
  document.getElementById('cfg-save').onclick = async function() {
    var parsed;
    if (configCurrentMode === 'form') {
      parsed = serializeForm();
    } else {
      var textarea = document.getElementById('config-textarea');
      try {
        parsed = JSON.parse(textarea.value);
      } catch (e) {
        showToast('Invalid JSON: ' + e.message, true);
        return;
      }
    }
    try {
      await requestJson('config', {
        method: 'POST',
        body: JSON.stringify({ options: parsed })
      });
      showToast('Config saved');
    } catch (e) { showToast('Save failed: ' + e.message, true); }
  };

  // Restart button with loading overlay and ping polling
  document.getElementById('cfg-restart').onclick = async function() {
    try {
      await requestJson('actions/restart', { method: 'POST', body: '{}' });
      var overlay = document.createElement('div');
      overlay.id = 'restart-overlay';
      overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);color:var(--text)';
      overlay.innerHTML = '<div style="text-align:center"><div style="font-size:24px;font-weight:600;margin-bottom:16px">Restarting...</div><div style="width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div><div style="margin-top:16px;color:var(--muted);font-size:14px" id="restart-status">Waiting for app to come back online</div></div>';
      document.body.appendChild(overlay);
      var attempt = 0;
      var poll = function() {
        attempt++;
        fetch(apiPath('ping'), { method: 'GET' }).then(function(r) {
          if (r.ok) {
            document.getElementById('restart-status').textContent = 'App is back online!';
            setTimeout(function() { var ov = document.getElementById('restart-overlay'); if (ov) ov.remove(); refreshAll(); }, 1000);
          } else { throw new Error('not ready'); }
        }).catch(function() {
          if (attempt < 60) {
            document.getElementById('restart-status').textContent = 'Waiting for app to come back online (' + attempt + 's)';
            setTimeout(poll, 1000);
          } else {
            var ov = document.getElementById('restart-overlay'); if (ov) ov.remove();
            showToast('Restart timed out', true);
          }
        });
      };
      setTimeout(poll, 2000);
    } catch (e) { showToast('Restart failed: ' + e.message, true); }
  };
}

/* ── Cards View ──────────────────────────────────────────── */
var CARD_STYLES = [
  { value: 'full', label: 'Full Dashboard' },
  { value: 'compact', label: 'Compact' },
  { value: 'glance', label: 'Glance' },
  { value: 'status', label: 'Status Only' },
  { value: 'controls', label: 'Controls Only' }
];

function buildCards() {
  var container = document.getElementById('cards-content');
  container.innerHTML = '';
  if (!state.health || !state.health.printers.length) {
    container.innerHTML = '<div class="card" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">No printers configured. Add printers in the Config tab.</p></div>';
    return;
  }

  var card = el('div', 'card');
  var styleOpts = CARD_STYLES.map(function(s) {
    return '<option value="' + escHtml(s.value) + '">' + escHtml(s.label) + '</option>';
  }).join('');

  var printerChecks = state.health.printers.map(function(p) {
    return '<label style="display:flex;align-items:center;gap:6px;cursor:pointer">' +
      '<input type="checkbox" class="cards-printer-cb" value="' + escHtml(p.printer_id) + '" checked> ' +
      escHtml(p.name) +
    '</label>';
  }).join('');

  card.innerHTML =
    '<div class="card-title">Lovelace Card Generator</div>' +
    '<div style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start;margin-bottom:12px">' +
      '<div>' +
        '<div style="font-size:12px;font-weight:500;margin-bottom:4px;opacity:.7">Card Style</div>' +
        '<select class="yaml-style-select" style="min-width:160px">' + styleOpts + '</select>' +
      '</div>' +
      '<div>' +
        '<div style="font-size:12px;font-weight:500;margin-bottom:4px;opacity:.7">Include Printers</div>' +
        '<div style="display:flex;flex-wrap:wrap;gap:8px 16px">' + printerChecks + '</div>' +
      '</div>' +
    '</div>' +
    '<div class="yaml-block" style="min-height:120px">Loading...</div>' +
    '<button class="btn btn-secondary btn-copy-yaml" style="margin-top:8px">Copy YAML</button>';

  var yamlBlock = card.querySelector('.yaml-block');
  var styleSelect = card.querySelector('.yaml-style-select');
  var copyBtn = card.querySelector('.btn-copy-yaml');
  var checkboxes = card.querySelectorAll('.cards-printer-cb');

  function loadCards() {
    var style = styleSelect.value;
    var ids = [];
    checkboxes.forEach(function(cb) { if (cb.checked) ids.push(cb.value); });
    if (!ids.length) {
      yamlBlock.textContent = '# Select at least one printer';
      return;
    }
    yamlBlock.textContent = 'Loading...';
    requestJson('cards?style=' + encodeURIComponent(style) + '&printers=' + encodeURIComponent(ids.join(',')))
      .then(function(resp) {
        yamlBlock.textContent = resp.lovelace_yaml || '# No YAML returned';
      })
      .catch(function(e) {
        yamlBlock.textContent = '# Error: ' + e.message;
      });
  }

  styleSelect.onchange = loadCards;
  checkboxes.forEach(function(cb) { cb.onchange = loadCards; });
  loadCards();

  copyBtn.onclick = function() {
    var text = yamlBlock.textContent;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('YAML copied to clipboard');
      });
    } else {
      var ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('YAML copied to clipboard');
    }
  };

  container.appendChild(card);
}

/* ── Templates View ─────────────────────────────────────── */
var TEMPLATE_DESCRIPTIONS = {
  color_bars: 'CMYK color swatches, gradients, and fine-line patterns to exercise all printer nozzles.',
  home_summary: 'Home Assistant instance overview with entity counts, active sensors, and key states.',
  weather_snapshot: 'Current weather conditions with temperature, humidity, wind, and tracked entities.',
  entity_report: 'Detailed state report for up to 12 configured Home Assistant entities.',
  hybrid: 'Combined weather snapshot and entity report on a single page.',
  daily_summary: 'Previous day\'s summary with energy use, sensor rollups, weather, household status, and colorful nozzle-exercising patterns.'
};

var tplExpandedTemplate = null;

function buildTemplates() {
  var container = document.getElementById('templates-content');
  container.innerHTML = '';
  if (!state.health) {
    container.innerHTML = '<div class="card" style="opacity:1;transform:none"><p style="color:var(--text-secondary)">Loading...</p></div>';
    return;
  }

  var printers = state.health.printers || [];

  // If a template is expanded, show detail view
  if (tplExpandedTemplate) {
    buildTemplateDetail(container, tplExpandedTemplate, printers);
    return;
  }

  // Template list view — one card per template
  TEMPLATE_OPTIONS.forEach(function(tpl) {
    var card = el('div', 'card');
    card.style.cursor = 'pointer';
    card.innerHTML =
      '<div style="display:flex;align-items:center;justify-content:space-between">' +
        '<div>' +
          '<div style="font-size:16px;font-weight:600;text-transform:capitalize">' + escHtml(tpl.replace(/_/g, ' ')) + '</div>' +
          '<div style="font-size:13px;color:var(--text-secondary);margin-top:4px">' + escHtml(TEMPLATE_DESCRIPTIONS[tpl] || '') + '</div>' +
        '</div>' +
        '<div style="color:var(--muted);font-size:20px">&rsaquo;</div>' +
      '</div>';
    card.onclick = function() {
      tplExpandedTemplate = tpl;
      buildTemplates();
    };
    container.appendChild(card);
  });
}

function buildTemplateDetail(container, tpl, printers) {
  // Back button
  var backRow = el('div', '', '');
  backRow.style.marginBottom = '12px';
  backRow.innerHTML = '<button class="btn btn-ghost" id="tpl-back" style="font-size:14px">&larr; All Templates</button>';
  container.appendChild(backRow);
  document.getElementById('tpl-back').onclick = function() {
    tplExpandedTemplate = null;
    buildTemplates();
    requestAnimationFrame(function() { animateCards(); });
  };

  var card = el('div', 'card');
  // Use first printer for preview if available
  var previewPid = printers.length ? printers[0].printer_id : '';

  var printerCheckboxes = '';
  if (printers.length > 1) {
    printerCheckboxes = '<div style="margin:12px 0"><div style="font-size:13px;font-weight:600;margin-bottom:8px">Print to:</div>';
    printers.forEach(function(p) {
      printerCheckboxes += '<label style="display:inline-flex;align-items:center;gap:6px;margin-right:16px;font-size:13px"><input type="checkbox" class="tpl-printer-cb" value="' + escHtml(p.printer_id) + '" checked> ' + escHtml(p.name) + '</label>';
    });
    printerCheckboxes += '</div>';
  }

  card.innerHTML =
    '<div style="font-size:20px;font-weight:600;text-transform:capitalize;margin-bottom:4px">' + escHtml(tpl.replace(/_/g, ' ')) + '</div>' +
    '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:16px">' + escHtml(TEMPLATE_DESCRIPTIONS[tpl] || '') + '</div>' +
    (previewPid ? '<img class="tpl-preview-img" src="' + escHtml(apiPath('printers/' + encodeURIComponent(previewPid) + '/preview?template=' + encodeURIComponent(tpl))) + '" alt="Template preview" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)">' : '<p style="color:var(--muted)">No printers configured for preview.</p>') +
    printerCheckboxes +
    '<div class="btn-row" style="margin-top:12px">' +
      '<button class="btn btn-primary" id="tpl-print-btn">Print Template</button>' +
    '</div>';

  container.appendChild(card);

  document.getElementById('tpl-print-btn').onclick = async function() {
    var targetPids = [];
    if (printers.length === 1) {
      targetPids = [printers[0].printer_id];
    } else {
      card.querySelectorAll('.tpl-printer-cb:checked').forEach(function(cb) {
        targetPids.push(cb.value);
      });
    }
    if (!targetPids.length) { showToast('Select at least one printer', true); return; }

    var sent = 0;
    for (var i = 0; i < targetPids.length; i++) {
      try {
        await requestJson('printers/' + encodeURIComponent(targetPids[i]) + '/print', {
          method: 'POST',
          body: JSON.stringify({ template: tpl, force: true })
        });
        sent++;
      } catch (e) { showToast('Print failed for printer: ' + e.message, true); }
    }
    if (sent) showToast('Print sent to ' + sent + ' printer(s)');
  };
}

/* ── Help View ──────────────────────────────────────────── */
var helpBuilt = false;

function buildHelp() {
  if (helpBuilt) return;
  helpBuilt = true;

  var container = document.getElementById('help-content');

  function helpCard(title, bodyHtml) {
    return '<div class="card"><div class="help-section-title">' + title + '</div><div class="help-body">' + bodyHtml + '</div></div>';
  }

  function collapsible(title, bodyHtml, collapsed) {
    return '<div class="help-collapsible' + (collapsed ? ' collapsed' : '') + '">' +
      '<div class="help-collapsible-header">' + escHtml(title) + '<span class="help-collapsible-chevron">&#9660;</span></div>' +
      '<div class="help-collapsible-body">' + bodyHtml + '</div></div>';
  }

  var html = '';

  // What is Printer Keepalive?
  html += helpCard('What is Printer Keepalive?',
    '<ul>' +
      '<li>Multi-printer IPP keepalive add-on for Home Assistant</li>' +
      '<li>Prevents inkjet nozzle dry-out by periodically printing small maintenance pages</li>' +
      '<li>Discovers network printers via mDNS/DNS-SD</li>' +
      '<li>Exposes printers as HA devices via MQTT discovery</li>' +
    '</ul>'
  );

  // Maintenance Model
  html += helpCard('Maintenance Model',
    '<ul>' +
      '<li>Tracks last print time from keepalive jobs, external printing (IPP impression counts), and initial startup</li>' +
      '<li>Calculates <code>next_keepalive_due = last_print + cadence_hours</code></li>' +
      '<li>Only prints when actually due (history-aware)</li>' +
    '</ul>'
  );

  // Inkjet vs Laser
  html += helpCard('Inkjet vs Laser',
    '<ul>' +
      '<li><strong>Inkjet:</strong> Needs frequent activity to reduce nozzle dry-out risk</li>' +
      '<li><strong>Laser:</strong> Toner is dry, tolerates idle periods better, but periodic test prints are still useful</li>' +
    '</ul>'
  );

  // Configuration Guide
  html += helpCard('Configuration Guide',
    '<p>Configure the add-on in the <a href="#" onclick="event.preventDefault();document.querySelector(\'[data-view=config]\').click()">Config tab</a>. Each section controls a different aspect:</p>' +
    '<h4>Printers</h4><p>Define multiple printers with individual URIs, types, cadences, and templates. Each printer runs independently.</p>' +
    '<h4>Scheduling</h4><p>Controls the internal auto-print scheduler and how often printer status is polled via IPP. Failure cooldown prevents rapid retries after errors.</p>' +
    '<h4>Discovery</h4><p>Network scanning for printers using mDNS/zeroconf. Produces ready-to-copy config snippets for found printers.</p>' +
    '<h4>Templates &amp; Content</h4><p>Default template and content settings inherited by printers that don\'t override them. Weather entity enables weather-aware templates.</p>' +
    '<h4>MQTT</h4><p>Enables Home Assistant device/entity discovery. Each printer becomes an HA device with sensors, switches, and buttons. Defaults to the HA Mosquitto broker.</p>' +
    '<h4>Integration</h4><p>For non-Supervisor installs, provide HA URL and long-lived token. Auth token protects write API endpoints.</p>'
  );

  // Exposed HA Entities
  html += helpCard('Exposed HA Entities',
    '<p>Each printer gets the following entities via MQTT:</p>' +
    '<div class="help-entity-grid">' +
      '<div class="help-entity-group">' +
        '<h4>Controls</h4>' +
        '<ul>' +
          '<li><code>switch</code> keepalive_enabled</li>' +
          '<li><code>select</code> template</li>' +
          '<li><code>number</code> cadence_hours</li>' +
          '<li><code>button</code> print_now</li>' +
        '</ul>' +
      '</div>' +
      '<div class="help-entity-group">' +
        '<h4>Status</h4>' +
        '<ul>' +
          '<li><code>binary_sensor</code> keepalive_needed</li>' +
          '<li><code>sensor</code> time_since_last_print</li>' +
          '<li><code>sensor</code> keepalive_print_count</li>' +
          '<li><code>sensor</code> next_keepalive_due</li>' +
          '<li><code>sensor</code> last_keepalive_result</li>' +
          '<li><code>sensor</code> printer_state</li>' +
          '<li><code>sensor</code> health</li>' +
        '</ul>' +
      '</div>' +
    '</div>' +
    '<h4>IPP Stats</h4>' +
    '<ul>' +
      '<li><code>sensor</code> queued_job_count</li>' +
      '<li><code>sensor</code> job_impressions_completed</li>' +
      '<li><code>sensor</code> media_sheets_completed</li>' +
      '<li><code>sensor</code> printer_up_time</li>' +
      '<li><code>sensor</code> lowest_marker_level</li>' +
    '</ul>'
  );

  // Print Templates
  html += helpCard('Print Templates',
    '<p>Six built-in templates are available. Preview them in the <a href="#" onclick="event.preventDefault();document.querySelector(\'[data-view=templates]\').click()">Templates tab</a>.</p>' +
    '<ul>' +
      '<li><strong>color_bars</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.color_bars) + '</li>' +
      '<li><strong>home_summary</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.home_summary) + '</li>' +
      '<li><strong>weather_snapshot</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.weather_snapshot) + '</li>' +
      '<li><strong>entity_report</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.entity_report) + '</li>' +
      '<li><strong>hybrid</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.hybrid) + '</li>' +
      '<li><strong>daily_summary</strong> &mdash; ' + escHtml(TEMPLATE_DESCRIPTIONS.daily_summary) + '</li>' +
    '</ul>'
  );

  // API Reference (collapsible)
  var apiBody =
    '<h4>GET Endpoints</h4>' +
    '<div class="help-endpoint"><span class="method">GET</span> /</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /health</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /config</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /printers</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /printers/{id}</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /printers/{id}/card</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /printers/{id}/preview</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /templates</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /guidance</div>' +
    '<div class="help-endpoint"><span class="method">GET</span> /discovery</div>' +
    '<h4>POST Endpoints</h4>' +
    '<div class="help-endpoint"><span class="method">POST</span> /print</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /printers/{id}/print</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /printers/{id}/settings</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /printers/{id}/poll</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /discovery/rescan</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /config</div>' +
    '<div class="help-endpoint"><span class="method">POST</span> /actions/restart</div>' +
    '<h4>Authentication</h4>' +
    '<p>When <code>auth_token</code> is configured, include a <code>Bearer</code> token in the <code>Authorization</code> header for write endpoints.</p>';

  html += helpCard('API Reference', collapsible('Show all API endpoints', apiBody, true));

  // Lovelace Cards
  html += helpCard('Lovelace Cards',
    '<p>Five card styles are available for your HA dashboard. Generate and copy YAML from the <a href="#" onclick="event.preventDefault();document.querySelector(\'[data-view=cards]\').click()">Cards tab</a>.</p>' +
    '<ul>' +
      '<li><strong>Full Dashboard</strong> &mdash; Complete printer overview with all stats and controls</li>' +
      '<li><strong>Compact</strong> &mdash; Condensed card with key info</li>' +
      '<li><strong>Glance</strong> &mdash; Minimal at-a-glance status</li>' +
      '<li><strong>Status Only</strong> &mdash; Printer status without controls</li>' +
      '<li><strong>Controls Only</strong> &mdash; Just the control buttons and inputs</li>' +
    '</ul>'
  );

  container.innerHTML = html;

  // Bind collapsible toggles
  container.querySelectorAll('.help-collapsible-header').forEach(function(hdr) {
    hdr.addEventListener('click', function() {
      hdr.parentElement.classList.toggle('collapsed');
    });
  });
}

/* ── Animation ───────────────────────────────────────────── */
function animateCards() {
  document.querySelectorAll('.view.active .card').forEach(function(c, i) {
    c.classList.remove('visible');
    setTimeout(function() { c.classList.add('visible'); }, 60 * i);
  });
}

/* ── Rebuild a specific view on tab switch ───────────────── */
function rebuildView(viewName) {
  switch (viewName) {
    case 'dashboard': buildDashboard(); break;
    case 'printers': buildPrinters(); break;
    case 'discovery': buildDiscovery(); break;
    case 'cards': buildCards(); break;
    case 'templates': buildTemplates(); break;
    case 'config': rebuildConfigIfNeeded(); break;
    case 'help': buildHelp(); break;
  }
}

var configDirty = false;

function rebuildConfigIfNeeded() {
  if (configDirty) {
    buildConfig();
    configDirty = false;
    // Reload config data
    requestJson('config').then(function(cfgResp) {
      state.config = cfgResp.options || {};
      configRawObj = state.config;
      var textarea = document.getElementById('config-textarea');
      if (textarea) textarea.value = JSON.stringify(configRawObj, null, 2);
      populateForm(configRawObj);
    }).catch(function() {});
  }
  updateConfigSummaries();
}

/* ── Refresh all data ────────────────────────────────────── */
async function refreshAll() {
  if (state.refreshInFlight) return;
  state.refreshInFlight = true;
  try {
    var results = await Promise.allSettled([
      requestJson('health'),
      requestJson('discovery')
    ]);

    if (results[0].status === 'fulfilled') {
      state.health = results[0].value;
    } else {
      console.error('Health fetch failed:', results[0].reason);
    }

    if (results[1].status === 'fulfilled') {
      state.discovery = results[1].value;
    } else {
      console.error('Discovery fetch failed:', results[1].reason);
    }

    if (state.health) {
      document.getElementById('version-badge').textContent = 'v' + state.health.version;
    }

    buildDashboard();
    buildPrinters();
    buildDiscovery();
    buildCards();
    buildTemplates();
    buildHelp();

    if (!state.configLoaded) {
      state.configLoaded = true;
      buildConfig();
      // Auto-load config on first run
      try {
        var cfgResp = await requestJson('config');
        state.config = cfgResp.options || {};
        configRawObj = state.config;
        var textarea = document.getElementById('config-textarea');
        if (textarea) textarea.value = JSON.stringify(configRawObj, null, 2);
        populateForm(configRawObj);
      } catch (e) { /* config load is optional */ }
    } else {
      configDirty = true;
    }
    updateConfigSummaries();

    requestAnimationFrame(function() {
      requestAnimationFrame(function() { animateCards(); });
    });
  } catch (e) {
    showToast('Refresh failed: ' + e.message, true);
  } finally {
    state.refreshInFlight = false;
  }
}

/* ── Init ────────────────────────────────────────────────── */
buildDashboard();
buildPrinters();
buildDiscovery();
buildCards();
buildTemplates();
buildHelp();
buildConfig();
refreshAll();
setInterval(refreshAll, 60000);
</script>
</body>
</html>
