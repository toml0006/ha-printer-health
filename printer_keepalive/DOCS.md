# Printer Keepalive

`Printer Keepalive` is a Home Assistant add-on for running IPP-based maintenance
printing across one or more printers.

For step-by-step installation and first run, see `GETTING_STARTED.md`.

It is designed to:

- Support an arbitrary number of printers.
- Discover network printers via mDNS/zeroconf (`_ipp._tcp` and optional `_ipps._tcp`).
- Expose each printer as a Home Assistant device (via MQTT discovery).
- Track printer activity history and only print keepalive pages when due.
- Offer HA-aware templates (`home_summary`, `weather_snapshot`, `entity_report`, `hybrid`).
- Publish printer health and IPP telemetry for dashboards and automations.

## Maintenance Model

The add-on uses print history plus a per-printer cadence:

1. It tracks the last known print time from:
   - Keepalive jobs submitted by this add-on.
   - External printing (when `job-impressions-completed` increases via IPP).
   - Initial history anchor at first startup.
2. It calculates `next_keepalive_due_at = last_print + cadence_hours`.
3. Scheduler/API calls with `only_if_needed` will print only when due.

This avoids unnecessary prints while still preventing long idle periods.

## Inkjet vs Laser Guidance

The add-on includes built-in guidance and source links in `/guidance` and
`/health` payloads.

- Inkjet: generally needs more frequent activity to reduce nozzle dry-out risk.
- Laser: toner is dry and usually tolerates idle periods better, but periodic
  test prints are still useful for readiness checks.

Referenced material:

- Canon inkjet periodic printing guidance:
  [Canon Manual](https://ij.manual.canon/ij/webmanual/Manual/All/TS8700%20series/EN/UG/ug-154.html)
- Epson ET-3850 maintenance/nozzle check guidance:
  [Epson Guide 1](https://download4.epson.biz/sec_pubs/et-3850_series/useg/en/GUID-381C0AF6-12DF-433B-9294-C8845DF3F126.htm),
  [Epson Guide 2](https://download4.epson.biz/sec_pubs/et-3850_series/useg/en/GUID-69CE27D1-1CF9-4678-BA12-3C538DFFFE8A.htm)
- Canon toner vs ink and laser storage guidance:
  [Canon Toner vs Ink](https://www.usa.canon.com/learning/training-articles/training-articles-list/printer-toner-vs-ink),
  [Canon Laser Toner Handling](https://downloads.canon.com/cpr/pdf/Manuals/eManuals/LBP3480_eManual/us_LBP3480_Manual/contents/12010030.html)

## Configuration

### Recommended (`printers[]`)

Use `printers` for multi-printer support.
`printer_uri` should ideally be a full IPP/IPPS URI; bare host/IP values are auto-normalized.

```yaml
printers:
  - id: office_et3850
    name: Office ET-3850
    printer_uri: ipp://192.168.1.40/ipp/print
    printer_type: inkjet
    enabled: true
    cadence_hours: 168
    template: hybrid
    weather_entity: weather.home
    entity_ids:
      - sensor.outdoor_temperature
      - sensor.indoor_humidity
    title: Office Printer Keepalive
    footer: Generated by Home Assistant
  - id: garage_laser
    name: Garage Laser
    printer_uri: ipp://192.168.1.41/ipp/print
    printer_type: laser
    enabled: true
    cadence_hours: 720
    template: color_bars
    entity_ids: []
```

### Legacy Single-Printer Mode

If `printers` is empty, the add-on falls back to:

- `printer_uri`
- `printer_type`
- `auto_print_interval_hours`
- global template/entity defaults

### MQTT Discovery (for HA devices/entities)

Enable MQTT to expose each printer as a Home Assistant device with sensors and controls.
By default, the add-on assumes the Home Assistant Mosquitto add-on (`core-mosquitto`).
On Supervisor installs, it also queries the local MQTT service metadata and can auto-apply
host/port/auth defaults when left unset.

```yaml
mqtt:
  enabled: true
  host: core-mosquitto
  port: 1883
  username: ""
  password: ""
  discovery_prefix: homeassistant
  topic_prefix: printer_keepalive
  retain: true
  tls: false
  client_id: printer_keepalive
```

### Printer Discovery (network scan)

The add-on can discover candidate printers and produce ready-to-copy config stubs.

```yaml
discovery_enabled: true
discovery_interval_minutes: 180
discovery_timeout_seconds: 6
discovery_ipp_query_timeout_seconds: 8
discovery_include_ipps: true
```

Discovery uses zeroconf/mDNS and returns suggested config payloads from:

- Service metadata (`rp`, `ty`, hostname/address)
- Optional IPP attribute queries (`printer-name`, `printer-make-and-model`, state)

Use:

- `GET /discovery` for cached discovery results
- `GET /discovery?force=true` to force a fresh scan
- `POST /discovery/rescan` to force a rescan (auth-protected when `auth_token` is set)

### Non-Supervisor Install Support

For Home Assistant Container installs, set:

- `ha_url` (example `http://homeassistant:8123`)
- `ha_token` (long-lived token)

If running as a Supervisor add-on, `SUPERVISOR_TOKEN` is used automatically.

### Printed Context + QR Code

Keepalive pages now include:

- Trigger/source (`scheduler`, `api`, `mqtt`)
- Why the page printed (due-by-cadence vs manual/forced request)
- Cadence and last/next print timing context
- Printer-specific Home Assistant signal lines (from configured `entity_ids`, then auto-matched entities)
- QR code to open the add-on page URL

Set `addon_page_url` to control the QR destination explicitly.
If `addon_page_url` is not set and `ha_url` is set, the add-on uses:

- `<ha_url>/hassio/addon/printer_keepalive/info`

Otherwise it falls back to the project docs URL.

## Local Development (Docker Sidecar)

This repo includes a local dev compose stack for the add-on.

Files:

- `printer_keepalive/dev/docker-compose.yml`
- `printer_keepalive/dev/options.example.json`
- `printer_keepalive/dev/data/options.json` (local, ignored by git)

Start from repo root:

```bash
make pk-dev-up
```

The service listens on `http://127.0.0.1:18099`.

Iteration flow:

1. Edit `printer_keepalive/app.py`.
2. Restart service: `make pk-dev-restart`.
3. Validate endpoints:
   - `make pk-dev-health`
   - `make pk-dev-discovery`
   - `make pk-dev-rescan`

Stop when done:

```bash
make pk-dev-down
```

## Exposed HA Entities (via MQTT Discovery)

Per printer, the add-on publishes:

- Controls:
  - `switch.<printer_id>_keepalive_enabled`
  - `select.<printer_id>_template`
  - `number.<printer_id>_cadence_hours`
  - `button.<printer_id>_print_now`
- Key status:
  - `binary_sensor.<printer_id>_keepalive_needed`
  - `sensor.<printer_id>_time_since_last_print`
  - `sensor.<printer_id>_keepalive_print_count`
  - `sensor.<printer_id>_next_keepalive_due`
  - `sensor.<printer_id>_last_keepalive_result`
  - `sensor.<printer_id>_printer_state`
  - `sensor.<printer_id>_health`
- IPP stats:
  - `sensor.<printer_id>_queued_job_count`
  - `sensor.<printer_id>_job_impressions_completed`
  - `sensor.<printer_id>_media_sheets_completed`
  - `sensor.<printer_id>_printer_up_time`
  - `sensor.<printer_id>_lowest_marker_level`

Health sensor attributes include richer IPP data and maintenance guidance.

## Ingress Dashboard

When installed as a Home Assistant add-on, open `Printer Keepalive` from the sidebar
to use the built-in ingress dashboard.

The dashboard provides:

- Service overview and discovery summary
- Full configuration editor (reads/writes `/data/options.json`)
- Per-printer runtime settings controls (`enabled`, `cadence_hours`, `template`)
- Per-printer actions (`print if needed`, `force print`, `poll now`)
- Discovery rescan button
- Restart action button (Supervisor add-on runtime)

If `auth_token` is configured, enter it in the dashboard session field to enable POST actions.

## API

- `GET /`
  - Returns the HTML dashboard (used by ingress and direct browser access).
- `GET /ui`
  - Alias for the dashboard UI.
- `GET /config`
  - Returns current options payload from `/data/options.json` (auth-protected when `auth_token` is set).
- `GET /health`
  - Global service state, all printer payloads, maintenance guidance.
- `GET /printers`
  - List printer payloads.
- `GET /printers/<printer_id>`
  - One printer payload.
- `GET /cards`
  - Returns a Lovelace YAML snippet covering multiple printers.
  - Optional `?style=` parameter: `full`, `compact`, `glance`, `status`, `controls`.
  - Optional `?printers=` parameter: comma-separated printer IDs (defaults to all).
- `GET /printers/<printer_id>/card`
  - Returns a Lovelace YAML snippet for a single printer health/control card.
  - Optional `?style=` parameter: `full`, `compact`, `glance`, `status`, `controls`.
- `GET /printers/<printer_id>/preview`
  - Returns a rendered template image as JPEG.
  - Optional `?template=` parameter (defaults to the printer's configured template).
- `GET /guidance`
  - Inkjet and laser maintenance guidance.
- `GET /discovery`
  - Printer discovery candidates and suggested config snippets.
- `GET /templates`
  - Supported templates.
- `POST /print`
  - Print for default or selected printer.
  - Body/query params:
    - `printer_id` (optional)
    - `template` (optional)
    - `force` (optional, `true` bypasses due-check)
- `POST /printers/<printer_id>/print`
- `POST /printers/<printer_id>/settings`
  - Body fields: `template`, `cadence_hours`, `enabled`
- `POST /printers/<printer_id>/poll`
- `POST /discovery/rescan`
  - Force discovery scan refresh.
- `POST /config`
  - Save add-on options to `/data/options.json`.
  - Accepts either full options object body or `{ "options": { ... } }`.
  - Changes are persisted but require restart to apply.
- `POST /actions/restart`
  - Requests self-restart via Supervisor API (available in add-on runtime).

If `auth_token` is set, send:

```bash
Authorization: Bearer <auth_token>
```

## Notes

- Requires reachable IPP printers (`ipptool` is used to print and query attributes).
- Not all printers expose all IPP attributes; unavailable stats are kept optional.
- Keepalive is history-aware: scheduled runs skip printing when not due.
